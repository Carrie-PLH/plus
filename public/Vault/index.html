<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Medical Memory Vault</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
    /* Main Brand Colors */
    --soft-sage: #a3b9a3;
    --warm-clay: #c97f6d;
    --piney-green: #3c5c5e;
    
    /* Light Colors */
    --lightest-mint: #ebf0eb;
    --light-pink: #ecd1cb;
    
    /* Accent Colors */
    --dusty-teal: #669999;
    --mossy-green: #687744;
    --muted-terra-cotta: #c2552a;
    
    /* Legacy naming for compatibility */
    --primary-green: #3c5c5e;  /* Piney green - CORRECTED */
    --primary-coral: #c97f6d;  /* Warm clay - CORRECTED */
    --dark: #3c5c5e;           /* Piney green - CORRECTED */
    --light-mint: #ebf0eb;     /* Lightest mint - CORRECTED */
    
    /* Neutral Colors */
    --border-light: #e5e7eb;
    --shadow: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-hover: 0 4px 12px rgba(0,0,0,0.15);
    
    /* Semantic colors harmonized with brand */
    --success: #687744;      /* Mossy green - CORRECTED */
    --success-light: #e8eee2;
    --warning: #c97f6d;      /* Warm clay - CORRECTED */
    --warning-light: #f7ede9;
    --error: #c2552a;        /* Muted terra cotta - CORRECTED */
    --error-light: #f9e8e2;
    --info: #669999;         /* Dusty teal - CORRECTED */
    --info-light: #e7f2f2;
}
</head>
<body>
  <h1>Medical Memory Vault</h1>
  <p class="hint">Timeline of episodes saved by your tools. Private to the signed-in user.</p>
  <nav>
    <a href="/">Home</a>
    <a href="/BriefMe/">BriefMe</a>
  </nav>

  <div class="panel">
    <div>
      <label>Type filter</label>
      <input id="typeFilter" type="text" placeholder="e.g., actionTracker" />
    </div>
    <div>
      <label>Tag filter</label>
      <input id="tagFilter" type="text" placeholder="e.g., briefme" />
    </div>
    <div>
      <label>Limit</label>
      <select id="limitSel">
        <option>10</option>
        <option selected>20</option>
        <option>50</option>
      </select>
    </div>
  </div>

  <div class="row">
    <button id="refreshBtn" class="btn-primary">Refresh</button>
    <button id="sampleBtn" class="btn-secondary">Create sample episode</button>
    <span id="status" class="hint"></span>
  </div>

  <div id="list" class="list"></div>

  <div class="row">
    <button id="loadMoreBtn" class="btn-secondary" style="display:none">Load more</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { firebaseConfig, FUNCTIONS_REGION } from "/lib/config.js";
    import { makeVaultHelpers } from "/lib/vault.js";

    // Init Firebase and anon auth
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await signInAnonymously(auth);

    // Vault helpers from your updated lib/vault.js
    const { saveToVault, listEpisodes } = makeVaultHelpers(app, FUNCTIONS_REGION);

    // UI handles
    const $ = (id) => document.getElementById(id);
    const typeFilter = $("typeFilter");
    const tagFilter  = $("tagFilter");
    const limitSel   = $("limitSel");
    const statusEl   = $("status");
    const listEl     = $("list");
    const loadMoreBtn = $("loadMoreBtn");

    let nextCursor = null;

    function setStatus(msg) { statusEl.textContent = msg || ""; }
    function fmtDate(s) {
      try { return new Date(s).toLocaleString(); } catch { return s || ""; }
    }
    function renderItems(items = [], append = false) {
      if (!append) listEl.innerHTML = "";
      for (const it of items) {
        const div = document.createElement("div");
        div.className = "card";
        const tags = Array.isArray(it.tags) ? it.tags.join(", ") : "";
        const rawText = it.raw?.text || "";
        div.innerHTML = `
          <strong>${it.title || "(Untitled)"}${it.type ? " [" + it.type + "]" : ""}</strong>
          <div class="meta">When: ${fmtDate(it.occurredAt)}${tags ? " • Tags: " + tags : ""}</div>
          ${rawText ? `<pre>${rawText.slice(0, 600)}${rawText.length > 600 ? " …" : ""}</pre>` : ""}
        `;
        listEl.appendChild(div);
      }
    }

    async function refresh(resetCursor = true) {
      try {
        setStatus("Loading…");
        if (resetCursor) nextCursor = null;
        const res = await listEpisodes({
          type: (typeFilter.value || undefined),
          tag:  (tagFilter.value || undefined),
          limit: Number(limitSel.value) || 20,
          cursor: nextCursor || undefined
        });
        if (!res?.ok) {
          setStatus("Load failed");
          return;
        }
        renderItems(res.items || [], !resetCursor);
        nextCursor = res.nextCursor || null;
        loadMoreBtn.style.display = nextCursor ? "" : "none";
        setStatus(nextCursor ? "More available" : "All caught up");
      } catch (err) {
        console.error(err);
        setStatus(err?.message || "Error");
      }
    }

    $("refreshBtn").addEventListener("click", () => refresh(true));
    loadMoreBtn.addEventListener("click", () => refresh(false));

    $("sampleBtn").addEventListener("click", async () => {
      try {
        setStatus("Saving sample…");
        const now = new Date();
        const res = await saveToVault({
          type: "toolOutput",
          title: "Sample episode",
          rawText: "Created from Vault page for smoke test.",
          structured: { from: "VaultPage", when: now.toISOString() },
          tags: ["sample","vault"],
          summarize: true
        });
        if (!res?.ok) {
          setStatus("Save failed");
          return;
        }
        setStatus("Saved. Refreshing…");
        await refresh(true);
      } catch (err) {
        console.error(err);
        setStatus(err?.message || "Save error");
      }
    });

    // Initial load
    refresh(true);
  </script>
  <script type="module" src="/lib/briefmeAuto.js"></script>
</body>
</html>