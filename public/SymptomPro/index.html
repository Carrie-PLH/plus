<!doctype html>
<html lang="en">
<head>
  <!-- Tiny inline favicon to avoid 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><text y="14" font-size="14">ðŸ©º</text></svg>'>
  <meta charset="utf-8" />
  <title>SymptomPro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font: 16px/1.5 system-ui, sans-serif; margin: 40px; max-width: 900px; }
    textarea { width: 100%; font: inherit; margin-bottom: 10px; }
    button { padding: 8px 14px; font: inherit; cursor: pointer; }
    pre { background: #f6f6f6; padding: 10px; white-space: pre-wrap; }
    .muted { color: #666; font-size: 13px; }
    nav a { color:#0a66c2; text-decoration:none; margin-right:10px; }
  </style>
</head>
<body>
  <nav>
    <a href="/">Home</a>
    <a href="/Vault/">Vault</a>
  </nav>

  <h1>SymptomPro</h1>
  <p>Paste patient inputs as JSON. Minimal example:</p>
  <pre>{
  "symptoms": {
    "chiefComplaint": "Throbbing headache",
    "onset": "2 days ago",
    "location": "Head",
    "duration": "Intermittent",
    "character": "Throbbing",
    "aggravating": "Bright light",
    "alleviating": "Rest",
    "radiation": "None",
    "timing": "Worse at night",
    "severity": "7/10"
  },
  "context": {
    "history": "No head trauma",
    "meds": "Ibuprofen PRN"
  }
}</pre>

  <form id="form">
    <label>Input JSON</label>
    <textarea id="input" rows="12" placeholder='{"symptoms": {...}, "context": {...}}'></textarea>
    <button type="submit">Generate OLD CARTS Summary</button>
    <p id="status" class="muted"></p>
  </form>

  <h3>Result</h3>
  <pre id="out">Click the button to generate.</pre>

  <script type="module">
    import { httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js";
    import { functions } from "/lib/appBootstrap.js";
    import {
      initAuth,
      saveEntryToVaultWithHooks,
      registerCopilotIngest,
    } from "/lib/briefmeSave.js";
  
    await initAuth();
    const hooks = registerCopilotIngest({ enabled: true, defaultTool: "symptompro" });
  
    const $ = (sel) => document.querySelector(sel);
    const form = $("#form");
    const input = $("#input");
    const out = $("#out");
    const status = $("#status");
  
    const log = (...a) => { console.log("[SymptomPro]", ...a); };
  
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      status.textContent = "";
      out.textContent = "Workingâ€¦";
  
      let payload;
      try {
        payload = JSON.parse(input.value || "{}");
      } catch {
        out.textContent = "Invalid JSON. Please fix and try again.";
        status.textContent = "Invalid JSON";
        return;
      }
  
      const symptoms = payload.symptoms || {};
      const context  = payload.context  || {};
      const title =
        "SymptomPro: " + (symptoms.chiefComplaint || symptoms.primarySymptom || "Summary");
  
      try {
        // 1) Generate
        status.textContent = "Generating summaryâ€¦";
        const cfGenerateSummary = httpsCallable(functions, "generateSummary");
        const resp = await cfGenerateSummary({ symptoms, context });
        log("generateSummary raw resp:", resp);
  
        const data = resp?.data || {};
        const summary = data.summary || "No summary produced.";
        out.textContent = summary;
  
        // 2) Save
        status.textContent = "Saving to Vaultâ€¦";
        const saveRes = await saveEntryToVaultWithHooks(
          {
            type: "symptomPro",
            title,
            structured: { symptoms, context, summary },
            extraTags: ["symptom", "OLD_CARTS"],
          },
          hooks
        );
        log("vault save result:", saveRes);
  
        status.textContent = "Saved to your Vault.";
      } catch (err) {
        console.error("SymptomPro error:", err);
        out.textContent = "Sorryâ€”generation or save failed.";
        status.textContent = String(err?.message || err);
      }
    });
  </script>

  <!-- Auto-inits CoPilot + form helpers for other pages; harmless here -->
  <script type="module" src="/lib/briefmeAuto.js"></script>
  <script type="module" src="/lib/welcomeCard.js"></script>
</body>
</html>