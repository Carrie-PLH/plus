<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Symptom Summary Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Emoji favicon -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><text y="14" font-size="14">ðŸ©º</text></svg>'>
  
  <!-- Roboto font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
:root {
    /* Main Brand Colors */
    --soft-sage: #a3b9a3;
    --warm-clay: #c97f6d;
    --piney-green: #3c5c5e;
    
    /* Light Colors */
    --lightest-mint: #ebf0eb;
    --light-pink: #ecd1cb;
    
    /* Accent Colors */
    --dusty-teal: #669999;
    --mossy-green: #687744;
    --muted-terra-cotta: #c2552a;
    
    /* Legacy naming for compatibility */
    --primary-green: #3c5c5e;  /* Piney green - CORRECTED */
    --primary-coral: #c97f6d;  /* Warm clay - CORRECTED */
    --dark: #3c5c5e;           /* Piney green - CORRECTED */
    --light-mint: #ebf0eb;     /* Lightest mint - CORRECTED */
    
    /* Variables actually used in the CSS */
    --brand-light: #fde8e4;    /* Light coral background */
    --brand-dark: #3c5c5e;     /* Piney green for headings */
    --brand-green: #3c5c5e;    /* Piney green */
    --brand-coral: #c97f6d;    /* Warm clay */
    --muted: #6c757d;          /* Gray for subtitles */
    --line: #e5e7eb;           /* Border color */
    
    /* Neutral Colors */
    --border-light: #e5e7eb;
    --shadow: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-hover: 0 4px 12px rgba(0,0,0,0.15);
    
    /* Semantic colors harmonized with brand */
    --success: #687744;      /* Mossy green - CORRECTED */
    --success-light: #e8eee2;
    --warning: #c97f6d;      /* Warm clay - CORRECTED */
    --warning-light: #f7ede9;
    --error: #c2552a;        /* Muted terra cotta - CORRECTED */
    --error-light: #f9e8e2;
    --info: #669999;         /* Dusty teal - CORRECTED */
    --info-light: #e7f2f2;
}
    
    * { box-sizing: border-box; }
    
    body {
      font-family: 'Roboto', system-ui, -apple-system, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background: #faf7f5; /* Very light warm neutral */
      color: var(--brand-dark);
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    header {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    h1 {
      margin: 0 0 8px;
      color: #3c5c5e;
      font-size: 28px;
      font-weight: 700;
    }
    
    .subtitle {
      color: var(--muted);
      margin: 0;
      font-size: 14px;
    }
    
    nav {
      margin-bottom: 16px;
    }
    
    nav a {
      color: var(--brand-coral);
      text-decoration: none;
      margin-right: 16px;
      font-weight: 500;
    }
    
    nav a:hover {
      text-decoration: underline;
    }
    
.form-section {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-left: 4px solid var(--brand-green); /* Add green accent border */
}
    
.form-section h2 {
  margin: 0 0 16px;
  color: var(--brand-dark);
  font-size: 20px;
  font-weight: 500;
  border-bottom: 2px solid var(--brand-green); /* This should be showing green */
  padding-bottom: 8px;
}
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--brand-dark);
    }
    
    .hint {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 8px;
      font-family: 'Roboto', sans-serif;
      font-size: 16px;
      transition: border-color 0.2s;
      background: white;
    }
    
input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: var(--brand-green);
  box-shadow: 0 0 0 3px rgba(60, 92, 94, 0.1); /* Green glow */
}
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .character-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    
    .chip-option {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border: 1px solid var(--line);
      border-radius: 20px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 40px;
    }
    
    .chip-option:hover {
      background: var(--brand-light);
    }
    
    .chip-option input {
      margin-right: 6px;
      cursor: pointer;
    }
    
    .chip-option.selected {
      background: var(--brand-green);
      color: white;
      border-color: var(--brand-green);
    }
    
    .severity-slider {
      margin-top: 12px;
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, var(--brand-green), var(--brand-coral));
      outline: none;
    }
    
input[type="range"] {
  flex: 1;
  height: 6px;
  border-radius: 3px;
  background: #e5e7eb; /* Light gray track */
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}

input[type="range"]::-webkit-slider-track {
  height: 6px;
  background: #e5e7eb;
  border-radius: 3px;
}

input[type="range"]::-moz-range-track {
  height: 6px;
  background: #e5e7eb;
  border-radius: 3px;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #c2552a; /* Muted terra cotta */
  cursor: pointer;
}

input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #c2552a; /* Muted terra cotta */
  cursor: pointer;
  border: none;
}
    
    .severity-display {
      font-weight: 700;
      font-size: 18px;
      color: var(--brand-dark);
      min-width: 40px;
      text-align: center;
    }
    
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    @media (max-width: 600px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }
    
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-family: 'Roboto', sans-serif;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 44px;
    }
    
    .btn-primary {
      background: var(--brand-coral);
      color: white;
    }
    
    .btn-primary:hover {
      background: #b86f5d;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(201, 127, 109, 0.3);
    }
    
    .btn-secondary {
      background: white;
      color: var(--brand-dark);
      border: 2px solid var(--brand-green);
    }
    
    .btn-secondary:hover {
      background: var(--brand-light);
    }
    
    #status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      display: none;
    }
    
    #status.success {
      background: rgba(76, 175, 80, 0.1);
      color: var(--success);
      border: 1px solid var(--success);
      display: block;
    }
    
    #status.error {
      background: rgba(244, 67, 54, 0.1);
      color: var(--error);
      border: 1px solid var(--error);
      display: block;
    }
    
    #status.working {
      background: rgba(163, 185, 163, 0.1);
      color: var(--brand-dark);
      border: 1px solid var(--brand-green);
      display: block;
    }
    
    .result-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-top: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: none;
    }
    
    .result-section.show {
      display: block;
    }
    
    .result-section h3 {
      margin: 0 0 16px;
      color: var(--brand-dark);
      font-size: 20px;
      font-weight: 500;
    }
    
    #summaryOutput {
      white-space: pre-wrap;
      line-height: 1.8;
      background: var(--brand-light);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--brand-green);
    }
    
    .tab-mode {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--line);
    }
    
    .tab {
      padding: 10px 16px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }
    
.tab.active {
  color: var(--brand-dark);
  border-bottom-color: var(--brand-green); /* Change from coral to green */
}
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    #jsonInput {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      min-height: 200px;
    }
    
    .tone-selector {
      margin-bottom: 20px;
      padding: 16px;
      background: var(--brand-light);
      border-radius: 8px;
    }
    
    .tone-options {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .tone-option {
      padding: 8px 16px;
      border: 2px solid var(--brand-green);
      border-radius: 20px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .tone-option:hover {
      background: var(--brand-light);
    }
    
    .tone-option.selected {
      background: var(--brand-green);
      color: white;
    }
    
    .summary-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--line);
      flex-wrap: wrap;
    }
    
    .summary-tab {
      padding: 10px 16px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      font-size: 14px;
    }
    
    .summary-tab.active {
      color: var(--brand-dark);
      border-bottom-color: var(--brand-coral);
    }
    
    .summary-content {
      display: none;
    }
    
    .summary-content.active {
      display: block;
    }
    
    .summary-description {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
      font-style: italic;
    }
  </style>
<link rel="stylesheet" href="/css/upgrade-overlay.css">
</head>
<body>
  <div class="container">
    <nav>
      <a href="/">Home</a>
      <a href="/Vault/">Vault</a>
      <a href="/BriefMe/">BriefMe Hub</a>
    </nav>
    
    <header>
      <h1>Bypass Time-Consuming Questions & Get to a Diagnosis Faster</h1>
      <p class="subtitle">Give your provider everything they need upfront so appointments are about you getting answers rather than giving information</p>
    </header>
    
    <div class="form-section">
      <div class="tab-mode">
        <button class="tab active" onclick="switchTab('form')">Guided Form</button>
        <button class="tab" onclick="switchTab('json')">Advanced (JSON)</button>
      </div>
      
      <!-- Form View -->
      <div id="formTab" class="tab-content active">
        <form id="symptomForm">
          <!-- Primary Symptom -->
          <div class="form-group">
            <label for="chiefComplaint">What symptom is bothering you most? *</label>
            <input type="text" id="chiefComplaint" name="chiefComplaint" placeholder="e.g., Severe headache, chest pain, extreme fatigue" required>
            <p class="hint">Be specific about what brought you to seek care</p>
          </div>
          
          <!-- ONSET -->
          <div class="form-section">
            <h2>When It Started</h2>
            <div class="two-column">
              <div class="form-group">
                <label for="onset">When did this start?</label>
                <input type="text" id="onset" name="onset" placeholder="e.g., 3 days ago, Tuesday morning, gradually over the past 2 weeks">
              </div>
              <div class="form-group">
                <label for="suddenGradual">Was it sudden or gradual?</label>
                <select id="suddenGradual" name="suddenGradual">
                  <option value="">Select...</option>
                  <option value="sudden">Sudden</option>
                  <option value="gradual">Gradual</option>
                  <option value="intermittent">Intermittent</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- LOCATION -->
          <div class="form-section">
            <h2>Where You Feel It</h2>
            <div class="form-group">
              <label for="location">Where exactly do you feel it?</label>
              <textarea id="location" name="location" placeholder="Point to where it hurts and describe it (e.g., right side of head above the ear, center of chest behind the breastbone, entire lower back from waist to tailbone)"></textarea>
            </div>
          </div>
          
          <!-- DURATION -->
          <div class="form-section">
            <h2>How Long It Lasts</h2>
            <div class="two-column">
              <div class="form-group">
                <label for="duration">How long does each episode last?</label>
                <input type="text" id="duration" name="duration" placeholder="e.g., Constant, a few minutes, 30 minutes to 2 hours, all day">
              </div>
              <div class="form-group">
                <label for="frequency">How often does it happen?</label>
                <input type="text" id="frequency" name="frequency" placeholder="e.g., Daily, 3-4 times per week, only with certain activities, randomly">
              </div>
            </div>
          </div>
          
          <!-- CHARACTER -->
          <div class="form-section">
            <h2>What It Feels Like</h2>
            <label>Choose words that describe your symptom (select all that apply):</label>
            <div class="character-options" id="characterOptions">
              <label class="chip-option">
                <input type="checkbox" name="character" value="Sharp"> Sharp
              </label>
              <label class="chip-option">
                <input type="checkbox" name="character" value="Dull"> Dull
              </label>
              <label class="chip-option">
                <input type="checkbox" name="character" value="Throbbing"> Throbbing
              </label>
              <label class="chip-option">
                <input type="checkbox" name="character" value="Burning"> Burning
              </label>
              <label class="chip-option">
                <input type="checkbox" name="character" value="Stabbing"> Stabbing
              </label>
              <label class="chip-option">
                <input type="checkbox" name="character" value="Aching"> Aching
              </label>
              <label class="chip-option">
                <input type="checkbox" name="character" value="Pressure"> Pressure
              </label>
              <label class="chip-option">
                <input type="checkbox" name="character" value="Cramping"> Cramping
              </label>
              <label class="chip-option">
                <input type="checkbox" name="character" value="Tingling"> Tingling
              </label>
              <label class="chip-option">
                <input type="checkbox" name="character" value="Numbness"> Numbness
              </label>
            </div>
            <div class="form-group" style="margin-top: 12px;">
              <label for="characterOther">Can't find the right word? Describe it here:</label>
              <input type="text" id="characterOther" name="characterOther" placeholder="Use your own words to describe how it feels">
            </div>
          </div>
          
          <!-- AGGRAVATING -->
          <div class="form-section">
            <h2>What Makes It Worse</h2>
            <div class="form-group">
              <label for="aggravating">What makes it worse?</label>
              <textarea id="aggravating" name="aggravating" placeholder="Activities, positions, foods, stress, weather, time of day, medications, or anything else that worsens symptoms"></textarea>
            </div>
          </div>
          
          <!-- RELIEVING/ALLEVIATING -->
          <div class="form-section">
            <h2>What Helps</h2>
            <div class="form-group">
              <label for="alleviating">What makes it better?</label>
              <textarea id="alleviating" name="alleviating" placeholder="Rest, medications (which ones?), heat/ice, specific positions, sleep, massage, or anything that provides relief"></textarea>
            </div>
          </div>
          
          <!-- RADIATION -->
          <div class="form-section">
            <h2>Does It Spread?</h2>
            <div class="form-group">
              <label for="radiation">Does the symptom spread or travel to other areas?</label>
              <input type="text" id="radiation" name="radiation" placeholder="e.g., Pain spreads down my left arm, stays in one place, moves from my back to my leg">
            </div>
          </div>
          
          <!-- TIMING -->
          <div class="form-section">
            <h2>Patterns & Timing</h2>
            <div class="form-group">
              <label for="timing">When is it worst? Any patterns?</label>
              <textarea id="timing" name="timing" placeholder="Time of day patterns, relationship to meals/activities, weather changes, stress, menstrual cycle, etc."></textarea>
            </div>
          </div>
          
          <!-- SEVERITY -->
          <div class="form-section">
            <h2>How Severe Is It?</h2>
            <label for="severity">Rate your pain/discomfort from 1 (mild) to 10 (worst imaginable)</label>
            <div class="severity-slider">
              <div class="slider-container">
                <span>Mild</span>
                <input type="range" id="severity" name="severity" min="1" max="10" value="5">
                <span>Severe</span>
                <div class="severity-display" id="severityValue">5</div>
              </div>
            </div>
          </div>
          
          <!-- CONTEXT -->
          <div class="form-section">
            <h2>Your Health Background</h2>
            <div class="form-group">
              <label for="history">Relevant medical history</label>
              <textarea id="history" name="history" placeholder="Include: similar past symptoms, chronic conditions, recent illnesses/injuries, surgeries, family history of similar issues"></textarea>
            </div>
            <div class="form-group">
              <label for="medications">Current medications</label>
              <textarea id="medications" name="medications" placeholder="List all prescription medications, over-the-counter drugs, and supplements you're taking (include doses if known)"></textarea>
            </div>
            <div class="form-group">
              <label for="impact">How is this affecting your daily life?</label>
              <textarea id="impact" name="impact" placeholder="e.g., Missing work/school, can't drive, avoiding social activities, trouble sleeping, unable to care for family"></textarea>
            </div>
          </div>
          
          <!-- Tone Selection -->
          <div class="tone-selector">
            <label>Choose a writing style for all your summaries:</label>
            <div class="tone-options">
              <label class="tone-option selected">
                <input type="radio" name="tone" value="professional" checked style="display:none">
                Professional
              </label>
              <label class="tone-option">
                <input type="radio" name="tone" value="friendly" style="display:none">
                Conversational
              </label>
              <label class="tone-option">
                <input type="radio" name="tone" value="direct" style="display:none">
                Brief & Direct
              </label>
              <label class="tone-option">
                <input type="radio" name="tone" value="detailed" style="display:none">
                Very Detailed
              </label>
            </div>
          </div>
          
          <div class="button-group">
            <button type="submit" class="btn-primary">Create My Summaries</button>
            <button type="button" class="btn-secondary" onclick="clearForm()">Start Over</button>
          </div>
        </form>
      </div>
      
      <!-- JSON View -->
      <div id="jsonTab" class="tab-content">
        <div class="form-group">
          <label for="jsonInput">Paste JSON Input</label>
          <textarea id="jsonInput" placeholder='{"symptoms": {...}, "context": {...}}'></textarea>
          <p class="hint">Advanced users can paste a JSON structure directly</p>
        </div>
        <div class="button-group">
          <button type="button" class="btn-primary" onclick="generateFromJSON()">Generate Summaries</button>
          <button type="button" class="btn-secondary" onclick="loadExample()">Load Example</button>
        </div>
      </div>
    </div>
    
    <div id="status" aria-live="polite"></div>
    
    <div id="resultSection" class="result-section">
      <h3>Your Symptom Summaries â€” Ready to Share</h3>
      
      <div class="summary-tabs">
        <button class="summary-tab active" onclick="switchSummary('clinical')">Full Summary</button>
        <button class="summary-tab" onclick="switchSummary('portal')">Portal Message</button>
        <button class="summary-tab" onclick="switchSummary('emergency')">Quick Version</button>
        <button class="summary-tab" onclick="switchSummary('referral')">For Specialists</button>
      </div>
      
      <div id="clinicalSummary" class="summary-content active">
        <p class="summary-description">Complete description for your next appointment</p>
        <pre id="clinicalOutput"></pre>
        <div class="button-group">
          <button type="button" class="btn-secondary" onclick="copySummary('clinical')">Copy</button>
          <button type="button" class="btn-secondary" onclick="downloadSummary('clinical')">Download</button>
        </div>
      </div>
      
      <div id="portalSummary" class="summary-content">
        <p class="summary-description">Ready to paste into your patient portal message</p>
        <pre id="portalOutput"></pre>
        <div class="button-group">
          <button type="button" class="btn-secondary" onclick="copySummary('portal')">Copy</button>
          <button type="button" class="btn-secondary" onclick="downloadSummary('portal')">Download</button>
        </div>
      </div>
      
      <div id="emergencySummary" class="summary-content">
        <p class="summary-description">Quick version for urgent care or ER visits</p>
        <pre id="emergencyOutput"></pre>
        <div class="button-group">
          <button type="button" class="btn-secondary" onclick="copySummary('emergency')">Copy</button>
          <button type="button" class="btn-secondary" onclick="downloadSummary('emergency')">Download</button>
        </div>
      </div>
      
      <div id="referralSummary" class="summary-content">
        <p class="summary-description">Professional format for specialist appointments</p>
        <pre id="referralOutput"></pre>
        <div class="button-group">
          <button type="button" class="btn-secondary" onclick="copySummary('referral')">Copy</button>
          <button type="button" class="btn-secondary" onclick="downloadSummary('referral')">Download</button>
        </div>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js";
    import { functions } from "/lib/appBootstrap.js";
    import {
      initAuth,
      saveEntryToVaultWithHooks,
      registerCopilotIngest,
    } from "/lib/briefmeSave.js";
    
    // Initialize auth and telemetry
    await initAuth();
    const hooks = registerCopilotIngest({ enabled: true, defaultTool: "symptompro" });
    
    // DOM elements
    const form = document.getElementById("symptomForm");
    const statusEl = document.getElementById("status");
    const resultSection = document.getElementById("resultSection");
    const severitySlider = document.getElementById("severity");
    const severityValue = document.getElementById("severityValue");
    const jsonInput = document.getElementById("jsonInput");
    
    // Store current summaries for copy/download
    let currentSummaries = {};
    
    // Update character chip styles
    document.querySelectorAll('.chip-option input').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          e.target.parentElement.classList.add('selected');
        } else {
          e.target.parentElement.classList.remove('selected');
        }
      });
    });
    
    // Tone selection
    document.querySelectorAll('.tone-option').forEach(option => {
      option.addEventListener('click', (e) => {
        document.querySelectorAll('.tone-option').forEach(o => o.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        e.currentTarget.querySelector('input').checked = true;
      });
    });
    
    // Tab switching
    window.switchTab = function(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      if (tab === 'form') {
        document.querySelector('.tab:first-child').classList.add('active');
        document.getElementById('formTab').classList.add('active');
      } else {
        document.querySelector('.tab:last-child').classList.add('active');
        document.getElementById('jsonTab').classList.add('active');
      }
    };
    
    // Summary tab switching
    window.switchSummary = function(type) {
      document.querySelectorAll('.summary-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.summary-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.summary-tab:nth-child(${
        type === 'clinical' ? 1 : 
        type === 'portal' ? 2 : 
        type === 'emergency' ? 3 : 4
      })`).classList.add('active');
      document.getElementById(`${type}Summary`).classList.add('active');
    };
    
    // Form submission
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // Build symptoms object from form
      const formData = new FormData(form);
      const characterValues = formData.getAll('character');
      
      const symptoms = {
        chiefComplaint: formData.get('chiefComplaint') || '',
        onset: formData.get('onset') || formData.get('suddenGradual') || '',
        location: formData.get('location') || '',
        duration: formData.get('duration') || '',
        character: characterValues.length > 0 ? characterValues.join(', ') : (formData.get('characterOther') || ''),
        aggravating: formData.get('aggravating') || '',
        alleviating: formData.get('alleviating') || '',
        radiation: formData.get('radiation') || '',
        timing: formData.get('timing') || '',
        severity: formData.get('severity') + '/10',
        frequency: formData.get('frequency') || ''
      };
      
      const context = {
        history: formData.get('history') || '',
        meds: formData.get('medications') || '',
        impact: formData.get('impact') || ''
      };
      
      const tone = formData.get('tone') || 'professional';
      
      await generateSummary(symptoms, context, tone);
    });
    
    // Generate from JSON
    window.generateFromJSON = async function() {
      try {
        const payload = JSON.parse(jsonInput.value || '{}');
        const symptoms = payload.symptoms || {};
        const context = payload.context || {};
        const tone = document.querySelector('input[name="tone"]:checked')?.value || 'professional';
        await generateSummary(symptoms, context, tone);
      } catch (err) {
        showStatus('Invalid JSON format. Please check and try again.', 'error');
      }
    };
    
    // Main generation function
    async function generateSummary(symptoms, context, tone) {
      showStatus('Organizing your symptoms into clear summaries...', 'working');
      
      const title = `Symptom Summary: ${symptoms.chiefComplaint || symptoms.primarySymptom || "Report"}`;
      
      try {
        // Call Firebase function with tone parameter
        const cfGenerateSummary = httpsCallable(functions, "generateSummary");
        const resp = await cfGenerateSummary({ symptoms, context, tone });
        
        const data = resp?.data || {};
        
        if (data.summaries) {
          // Store summaries for copy/download
          currentSummaries = data.summaries;
          
          // Display each summary type
          document.getElementById('clinicalOutput').textContent = data.summaries.clinical || "Unable to generate clinical summary.";
          document.getElementById('portalOutput').textContent = data.summaries.portal || "Unable to generate portal message.";
          document.getElementById('emergencyOutput').textContent = data.summaries.emergency || "Unable to generate emergency summary.";
          document.getElementById('referralOutput').textContent = data.summaries.referral || "Unable to generate referral summary.";
          
          resultSection.classList.add('show');
          
          // Reset to first tab
          switchSummary('clinical');
        } else {
          // Fallback for backward compatibility
          const summary = data.summary || "No summary produced.";
          document.getElementById('clinicalOutput').textContent = summary;
          currentSummaries = { clinical: summary };
          resultSection.classList.add('show');
        }
        
        // Save to Vault
        showStatus('Saving to your Vault...', 'working');
        const saveRes = await saveEntryToVaultWithHooks(
          {
            type: "symptomPro",
            title,
            structured: { symptoms, context, summaries: currentSummaries, tone },
            extraTags: ["symptom", "OLD_CARTS", tone],
          },
          hooks
        );
        
        showStatus('âœ“ Your symptom summaries are ready and saved', 'success');
        
        // Scroll to results
        resultSection.scrollIntoView({ behavior: 'smooth' });
        
      } catch (err) {
        console.error("Summary generation error:", err);
        showStatus(`Error: ${err?.message || 'Unable to generate summaries. Please try again.'}`, 'error');
      }
    }
    
    // Helper functions
    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = type || '';
    }
    
    window.clearForm = function() {
      form.reset();
      severityValue.textContent = '5';
      document.querySelectorAll('.chip-option').forEach(chip => {
        chip.classList.remove('selected');
      });
      resultSection.classList.remove('show');
      statusEl.className = '';
      statusEl.textContent = '';
      currentSummaries = {};
    };
    
    window.copySummary = function(type) {
      const text = currentSummaries[type] || document.getElementById(`${type}Output`).textContent;
      navigator.clipboard.writeText(text)
        .then(() => showStatus('âœ“ Copied to clipboard!', 'success'))
        .catch(() => showStatus('Failed to copy', 'error'));
    };
    
    window.downloadSummary = function(type) {
      const text = currentSummaries[type] || document.getElementById(`${type}Output`).textContent;
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `symptom-${type}-summary.txt`;
      a.click();
      URL.revokeObjectURL(url);
    };
    
    window.loadExample = function() {
      const example = {
        symptoms: {
          chiefComplaint: "Severe throbbing headache",
          onset: "Started 2 days ago after a stressful work week",
          location: "Right side of head, behind and above my right eye",
          duration: "Constant for the past 48 hours",
          character: "Throbbing, pulsating, like a hammer",
          aggravating: "Bright lights, loud sounds, any movement, bending over",
          alleviating: "Dark quiet room, sleep, ice pack on head",
          radiation: "Sometimes spreads down to my neck and shoulder",
          timing: "Started in the morning, gets worse in the afternoon",
          severity: "8/10",
          frequency: "This severe headache happens about once a month"
        },
        context: {
          history: "Family history of migraines (mother and sister). I've had similar episodes monthly for the past 3 years.",
          meds: "Currently taking ibuprofen 400mg every 6 hours with minimal relief. Tried sumatriptan yesterday.",
          impact: "Had to call out of work for 2 days. Can't take care of my kids. Nausea is preventing me from eating regular meals."
        }
      };
      jsonInput.value = JSON.stringify(example, null, 2);
    };
  </script>
  
  <!-- Auto-init helpers -->
  <script type="module" src="/lib/briefmeAuto.js"></script>
<script type="module" src="/lib/toolAccessCheck.js"></script>

<script>
  // Fix severity slider - runs after DOM is loaded
  window.addEventListener('load', function() {
    const severitySlider = document.getElementById("severity");
    const severityValue = document.getElementById("severityValue");
    
    if (severitySlider && severityValue) {
      severitySlider.addEventListener("input", function(e) {
        severityValue.textContent = e.target.value;
      });
    }
  });
</script>
</body>
</html>
