<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>StoryLab - BriefMe</title>
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><text y="14" font-size="14">📖</text></svg>'>
    
    <!-- Brand tokens + Tailwind build -->
    <!-- In production, these would be served from your actual /dist folder -->
    <link rel="stylesheet" href="/dist/brand.css">
    <link rel="stylesheet" href="/dist/app.css">
    
    <!-- Roboto Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
/* Fallback styles for when brand.css isn't available (e.g., in artifact viewer) */
/* These match the PatientLead+ Brand System - CORRECTED COLORS */
:root {
    /* Main Brand Colors */
    --soft-sage: #a3b9a3;
    --warm-clay: #c97f6d;
    --piney-green: #3c5c5e;
    
    /* Light Colors */
    --lightest-mint: #ebf0eb;
    --light-pink: #ecd1cb;
    
    /* Accent Colors */
    --dusty-teal: #669999;
    --mossy-green: #687744;
    --muted-terra-cotta: #c2552a;
    
    /* Legacy naming for compatibility */
    --primary-green: #3c5c5e;  /* Piney green - CORRECTED */
    --primary-coral: #c97f6d;  /* Warm clay - CORRECTED */
    --dark: #3c5c5e;           /* Piney green - CORRECTED */
    --light-mint: #ebf0eb;     /* Lightest mint - CORRECTED */
    
    /* Neutral Colors */
    --border-light: #e5e7eb;
    --shadow: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-hover: 0 4px 12px rgba(0,0,0,0.15);
    
    /* Semantic colors harmonized with brand */
    --success: #687744;      /* Mossy green - CORRECTED */
    --success-light: #e8eee2;
    --warning: #c97f6d;      /* Warm clay - CORRECTED */
    --warning-light: #f7ede9;
    --error: #c2552a;        /* Muted terra cotta - CORRECTED */
    --error-light: #f9e8e2;
    --info: #669999;         /* Dusty teal - CORRECTED */
    --info-light: #e7f2f2;
}

* { box-sizing: border-box; }

body {
    font-family: 'Roboto', system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, var(--lightest-mint) 0%, #ffffff 100%);
    color: var(--dark);
    margin: 0;
    padding: 0;
    min-height: 100vh;
    line-height: 1.6;
}

.container {
    max-width: 1024px;
    margin: 0 auto;
    padding: 20px;
}

/* Header */
header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    padding: 12px 0;
    border-bottom: 2px solid var(--soft-sage);
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 700;
    font-size: 22px;
    color: var(--dark);
    text-decoration: none;
    transition: transform 0.2s ease;
}

.logo:hover { transform: translateX(-2px); }

.logo-badge {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--soft-sage), var(--warm-clay));
    box-shadow: var(--shadow);
}

nav {
    display: flex;
    gap: 24px;
    align-items: center;
}

nav a {
    color: var(--dark);
    text-decoration: none;
    font-weight: 500;
    padding: 8px 16px;
    border-radius: 8px;
    transition: all 0.2s ease;
}

nav a:hover {
    background: var(--light-pink);
    color: var(--piney-green);
}

/* Tool Header */
.tool-header {
    background: white;
    padding: 32px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 24px;
    border-left: 4px solid var(--warm-clay);
}

.tool-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    color: var(--dark);
}

.tool-header p {
    margin: 0 0 16px 0;
    color: #6b7280;
    font-size: 18px;
}

.quick-stats {
    display: flex;
    gap: 24px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-light);
}

.stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 16px;
    background: var(--light-pink);
    border-radius: 8px;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--mossy-green);
}

.stat-label {
    font-size: 12px;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Mode Selector */
.mode-container {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 24px;
}

.mode-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}

.mode-btn {
    padding: 16px;
    background: var(--lightest-mint);
    color: var(--dark);
    border: 2px solid transparent;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.mode-btn:hover:not(.active) {
    background: var(--light-pink);
    border-color: var(--soft-sage);
}

.mode-btn.active {
    background: var(--piney-green);
    color: white;
    box-shadow: var(--shadow);
}

.mode-description {
    font-size: 12px;
    opacity: 0.8;
    margin-top: 4px;
    font-weight: 400;
}

/* Cards */
.card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    transition: box-shadow 0.3s ease;
}

.card:hover { box-shadow: var(--shadow-hover); }

/* Input Section */
.input-section {
    margin-bottom: 24px;
}

.input-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
}

.input-helper {
    font-size: 14px;
    color: #6b7280;
    margin-left: 8px;
    font-weight: 400;
}

.input-textarea {
    width: 100%;
    min-height: 150px;
    padding: 16px;
    border: 2px solid var(--border-light);
    border-radius: 8px;
    font-size: 16px;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.3s ease;
}

.input-textarea:focus {
    outline: none;
    border-color: var(--soft-sage);
    box-shadow: 0 0 0 3px rgba(163, 185, 163, 0.2);
}

/* Voice Recording */
.voice-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-top: 12px;
}

.voice-btn {
    padding: 12px 20px;
    background: var(--warm-clay);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.voice-btn:hover:not(:disabled) {
    background: #b56f5f;
    transform: translateY(-2px);
}

.voice-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.voice-btn.recording {
    background: var(--error);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

.recording-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    color: var(--error);
    font-weight: 500;
}

.recording-indicator.active {
    display: flex;
}

.recording-dot {
    width: 12px;
    height: 12px;
    background: var(--error);
    border-radius: 50%;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.btn-primary, .btn-secondary {
    padding: 14px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 48px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: var(--piney-green);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: #2a4446;
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.btn-secondary {
    background: white;
    color: var(--piney-green);
    border: 2px solid var(--soft-sage);
}

.btn-secondary:hover:not(:disabled) {
    background: var(--soft-sage);
    color: white;
    border-color: var(--soft-sage);
}

.btn-primary:disabled, .btn-secondary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Validation Mirror */
.validation-mirror {
    display: none;
    padding: 20px;
    background: var(--lightest-mint);
    border-left: 4px solid var(--soft-sage);
    border-radius: 8px;
    margin-top: 16px;
}

.validation-mirror h4 {
    margin: 0 0 8px 0;
    color: var(--mossy-green);
    font-size: 16px;
}

.validation-content {
    color: var(--dark);
    font-style: italic;
    line-height: 1.6;
}

/* Output Grid */
.output-container {
    display: none;
    margin-top: 32px;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.output-header {
    margin-bottom: 24px;
    padding: 16px;
    background: linear-gradient(135deg, var(--lightest-mint), white);
    border-radius: 8px;
}

.output-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 8px;
}

.output-grid {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}

.output-card {
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--shadow);
}

.output-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.output-label {
    font-weight: 600;
    color: var(--dark);
    font-size: 18px;
}

.output-sublabel {
    color: #6b7280;
    font-size: 14px;
    margin-top: 4px;
}

.copy-btn {
    padding: 8px 16px;
    background: var(--dusty-teal);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.copy-btn:hover {
    background: #568080;
    transform: translateY(-1px);
}

.output-content {
    padding: 16px;
    background: var(--lightest-mint);
    border-radius: 8px;
    border-left: 3px solid var(--soft-sage);
    line-height: 1.8;
    font-size: 15px;
}

/* Evidence List */
.evidence-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.evidence-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 16px;
    background: var(--lightest-mint);
    border-radius: 8px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.evidence-item:hover {
    background: #dfe5df;
    transform: translateX(4px);
}

.evidence-bullet {
    width: 8px;
    height: 8px;
    background: var(--mossy-green);
    border-radius: 50%;
    margin-top: 8px;
    flex-shrink: 0;
}

.evidence-text {
    flex: 1;
    line-height: 1.6;
}

/* Comprehensive Mode */
.comprehensive-section {
    display: none;
}

.comprehensive-section.active {
    display: block;
}

.oldcarts-builder {
    display: grid;
    gap: 16px;
}

.oldcarts-field {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.oldcarts-label {
    font-weight: 600;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.oldcarts-input {
    padding: 12px;
    border: 2px solid var(--border-light);
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.3s ease;
}

.oldcarts-input:focus {
    outline: none;
    border-color: var(--soft-sage);
    box-shadow: 0 0 0 3px rgba(163, 185, 163, 0.2);
}

/* Pattern Detection */
.pattern-detection {
    margin-top: 20px;
    padding: 16px;
    background: linear-gradient(135deg, var(--warning-light), #ffffff);
    border-radius: 8px;
    border-left: 3px solid var(--warning);
}

.pattern-title {
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.pattern-list {
    list-style: none;
    padding: 0;
    margin: 8px 0;
}

.pattern-item {
    padding: 8px;
    background: white;
    border-radius: 6px;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Timeline Viewer */
.timeline-viewer {
    margin-top: 20px;
    padding: 20px;
    background: white;
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

.timeline-header {
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 16px;
}

.timeline-track {
    position: relative;
    padding: 20px 0;
}

.timeline-line {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--border-light);
}

.timeline-events {
    position: relative;
    display: flex;
    justify-content: space-between;
}

.timeline-event {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.timeline-dot {
    width: 16px;
    height: 16px;
    background: var(--mossy-green);
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: var(--shadow);
    z-index: 1;
}

.timeline-label {
    font-size: 12px;
    color: #6b7280;
    text-align: center;
    max-width: 80px;
}

/* Power User Mode Features */
.power-features {
    display: none;
    margin-top: 20px;
    padding: 20px;
    background: linear-gradient(135deg, var(--lightest-mint), var(--light-pink));
    border-radius: 8px;
}

.power-features.active {
    display: block;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 16px;
}

.feature-btn {
    padding: 12px;
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.feature-btn:hover {
    background: var(--light-pink);
    border-color: var(--dusty-teal);
}

/* Loading States */
.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.toast {
    background: white;
    padding: 16px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-top: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease;
    max-width: 350px;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--error); }
.toast.info { border-left: 4px solid var(--info); }
.toast.warning { border-left: 4px solid var(--warning); }

/* Privacy Badge */
.privacy-badge {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: var(--mossy-green);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 8px;
}

.privacy-icon {
    width: 16px;
    height: 16px;
}

/* Integration Panel */
.integration-panel {
    margin-top: 20px;
    padding: 16px;
    background: var(--lightest-mint);
    border-radius: 8px;
    border: 1px dashed var(--soft-sage);
}

.integration-title {
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 12px;
}

.integration-links {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.integration-link {
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    text-decoration: none;
    color: var(--dark);
    font-size: 14px;
    transition: all 0.2s ease;
}

.integration-link:hover {
    background: var(--dusty-teal);
    color: white;
    border-color: var(--dusty-teal);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .container { padding: 16px; }
    
    .tool-header {
        padding: 20px;
    }
    
    .tool-header h1 { font-size: 24px; }
    
    .mode-selector {
        grid-template-columns: 1fr;
    }
    
    .output-grid {
        grid-template-columns: 1fr;
    }
    
    nav {
        gap: 12px;
    }
    
    nav a {
        padding: 6px 12px;
        font-size: 14px;
    }
    
    .privacy-badge {
        position: static;
        margin-top: 20px;
        border-radius: 8px;
    }
}

/* Accessibility */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Focus Indicators */
*:focus-visible {
    outline: 2px solid var(--soft-sage);
    outline-offset: 2px;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <a href="/BriefMe/" class="logo">
                <div class="logo-badge"></div>
                <span>BriefMe Suite</span>
            </a>
            <nav>
                <a href="/BriefMe/PrepCommand/">PrepCommand</a>
                <a href="/Vault/">My Vault</a>
                <a href="/">Home</a>
            </nav>
        </header>

        <!-- Tool Header with Stats -->
        <div class="tool-header" style="
  padding: 24px 24px 24px 24px;
  margin-bottom: 32px;
">
  <h1 style="
    font-family: 'Roboto', sans-serif;
    font-size: 28px;
    font-weight: 700;
    color: #2c3e50;
    line-height: 1.3;
    margin: 0 0 8px 0;
  ">
    Transform Chaos Into Clarity, Dismissal Into Action
  </h1>
  
  <p style="
    font-family: 'Roboto', sans-serif;
    font-size: 16px;
    font-weight: 400;
    color: #6c757d;
    line-height: 1.5;
    margin: 0;
  ">
    Turn scattered symptoms into a compelling medical case that makes providers take notice
  </p>
</div>

        <!-- Mode Selector -->
        <div class="mode-container">
            <div class="mode-selector">
                <button class="mode-btn active" onclick="switchMode('quick')" id="quickModeBtn">
                    Quick Mode
                    <div class="mode-description">90-second story → instant narrative</div>
                </button>
                <button class="mode-btn" onclick="switchMode('guided')" id="guidedModeBtn">
                    Guided Mode
                    <div class="mode-description">Structured OLD CARTS builder</div>
                </button>
                <button class="mode-btn" onclick="switchMode('power')" id="powerModeBtn">
                    Power Mode
                    <div class="mode-description">Advanced features + analytics</div>
                </button>
            </div>
        </div>

        <!-- Quick Mode Section -->
        <div id="quickMode" class="card">
            <div class="input-section">
                <label for="storyInput" class="input-label">
                    Tell Your Story
                    <span class="input-helper">(voice or text - aim for 90 seconds)</span>
                </label>
                
                <textarea 
                    id="storyInput" 
                    class="input-textarea"
                    placeholder="Example: 'The headaches started about 3 months ago after I had a sinus infection. They happen mostly in the morning and feel like pressure behind my eyes. Sometimes they last all day...'"
                ></textarea>
                
                <div class="voice-controls">
                    <button class="voice-btn" id="voiceRecordBtn" onclick="toggleVoiceRecording()">
                        <span id="recordIcon">🎤</span>
                        <span id="recordText">Start Voice Recording</span>
                    </button>
                    <div class="recording-indicator" id="recordingIndicator">
                        <div class="recording-dot"></div>
                        <span id="recordingTime">0:00</span>
                    </div>
                </div>
            </div>

            <div class="validation-mirror" id="validationMirror">
                <h4>What I heard:</h4>
                <div class="validation-content" id="validationContent"></div>
            </div>

            <div class="action-buttons">
                <button class="btn-primary" id="generateBtn" onclick="generateStory()">
                    <span>Generate My Story</span>
                </button>
                <button class="btn-secondary" onclick="clearAndReset()">
                    Start Over
                </button>
            </div>
        </div>

        <!-- Guided Mode Section -->
        <div id="guidedMode" class="card comprehensive-section">
            <h3>Guided Story Builder (OLD CARTS)</h3>
            <p style="color: #6b7280; margin-bottom: 24px;">
                Answer these questions to build a complete medical narrative. Skip any that don't apply.
            </p>

            <div class="oldcarts-builder">
                <div class="oldcarts-field">
                    <label class="oldcarts-label">
                        <span>⏰</span> Onset: When did this start?
                    </label>
                    <input type="text" id="onset" class="oldcarts-input" 
                           placeholder="e.g., 3 months ago, last Tuesday, after the accident">
                </div>

                <div class="oldcarts-field">
                    <label class="oldcarts-label">
                        <span>📍</span> Location: Where do you feel it?
                    </label>
                    <input type="text" id="location" class="oldcarts-input" 
                           placeholder="e.g., lower back, behind my eyes, whole body">
                </div>

                <div class="oldcarts-field">
                    <label class="oldcarts-label">
                        <span>⏱️</span> Duration: How long does it last?
                    </label>
                    <input type="text" id="duration" class="oldcarts-input" 
                           placeholder="e.g., few minutes, all day, comes and goes">
                </div>

                <div class="oldcarts-field">
                    <label class="oldcarts-label">
                        <span>💢</span> Character: What does it feel like?
                    </label>
                    <input type="text" id="character" class="oldcarts-input" 
                           placeholder="e.g., sharp, dull ache, burning, throbbing">
                </div>

                <div class="oldcarts-field">
                    <label class="oldcarts-label">
                        <span>⬆️</span> Aggravating: What makes it worse?
                    </label>
                    <input type="text" id="aggravating" class="oldcarts-input" 
                           placeholder="e.g., walking, stress, certain foods">
                </div>

                <div class="oldcarts-field">
                    <label class="oldcarts-label">
                        <span>⬇️</span> Relieving: What makes it better?
                    </label>
                    <input type="text" id="relieving" class="oldcarts-input" 
                           placeholder="e.g., rest, medication, heat/cold">
                </div>

                <div class="oldcarts-field">
                    <label class="oldcarts-label">
                        <span>🔄</span> Timing: When does it occur?
                    </label>
                    <input type="text" id="timing" class="oldcarts-input" 
                           placeholder="e.g., mornings, after meals, randomly">
                </div>

                <div class="oldcarts-field">
                    <label class="oldcarts-label">
                        <span>📊</span> Severity: Rate it 1-10
                    </label>
                    <input type="text" id="severity" class="oldcarts-input" 
                           placeholder="e.g., 7/10, mild to moderate, severe">
                </div>
            </div>

            <div class="action-buttons" style="margin-top: 24px;">
                <button class="btn-primary" onclick="generateFromOLDCARTS()">
                    Generate From Details
                </button>
                <button class="btn-secondary" onclick="clearOLDCARTS()">
                    Clear Form
                </button>
            </div>
        </div>

        <!-- Power Mode Features -->
        <div id="powerMode" class="card power-features">
            <h3>Power User Features</h3>
            <div class="feature-grid">
                <button class="feature-btn" onclick="analyzePatterns()">
                    🔍 Analyze Patterns
                </button>
                <button class="feature-btn" onclick="compareStories()">
                    📊 Compare Versions
                </button>
                <button class="feature-btn" onclick="exportData()">
                    📄 Export All Data
                </button>
                <button class="feature-btn" onclick="importFromVault()">
                    📥 Import from Vault
                </button>
                <button class="feature-btn" onclick="generateTimeline()">
                    📈 Generate Timeline
                </button>
                <button class="feature-btn" onclick="smartSuggestions()">
                    💡 Smart Suggestions
                </button>
            </div>

            <!-- Pattern Detection Panel -->
            <div class="pattern-detection">
                <div class="pattern-title">
                    ⚡ Detected Patterns
                </div>
                <ul class="pattern-list" id="patternList">
                    <li class="pattern-item">Morning symptoms detected - consider sleep factors</li>
                    <li class="pattern-item">Stress correlation identified - document triggers</li>
                </ul>
            </div>

            <!-- Timeline Viewer -->
            <div class="timeline-viewer">
                <div class="timeline-header">📅 Symptom Timeline</div>
                <div class="timeline-track">
                    <div class="timeline-line"></div>
                    <div class="timeline-events">
                        <div class="timeline-event">
                            <div class="timeline-dot"></div>
                            <div class="timeline-label">3 months ago</div>
                        </div>
                        <div class="timeline-event">
                            <div class="timeline-dot"></div>
                            <div class="timeline-label">6 weeks ago</div>
                        </div>
                        <div class="timeline-event">
                            <div class="timeline-dot"></div>
                            <div class="timeline-label">Today</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Output Container -->
        <div id="outputContainer" class="output-container">
            <div class="output-header">
                <div class="output-title">Your Generated Narratives</div>
                <p style="color: #6b7280;">AI-enhanced versions ready for your provider</p>
            </div>

            <div class="output-grid">
                <!-- 30-Second Opener -->
                <div class="output-card">
                    <div class="output-card-header">
                        <div>
                            <div class="output-label">30-Second Opener</div>
                            <div class="output-sublabel">Start your visit strong</div>
                        </div>
                        <button class="copy-btn" onclick="copyToClipboard('opener')">Copy</button>
                    </div>
                    <div class="output-content" id="openerContent">
                        <!-- Generated opener content -->
                    </div>
                </div>

                <!-- 2-Minute Full Story -->
                <div class="output-card">
                    <div class="output-card-header">
                        <div>
                            <div class="output-label">2-Minute Story</div>
                            <div class="output-sublabel">Complete narrative</div>
                        </div>
                        <button class="copy-btn" onclick="copyToClipboard('story')">Copy</button>
                    </div>
                    <div class="output-content" id="storyContent">
                        <!-- Generated story content -->
                    </div>
                </div>

                <!-- Evidence List -->
                <div class="output-card" style="grid-column: 1 / -1;">
                    <div class="output-card-header">
                        <div>
                            <div class="output-label">Evidence & Facts</div>
                            <div class="output-sublabel">Objective information from your story</div>
                        </div>
                        <button class="copy-btn" onclick="copyToClipboard('evidence')">Copy List</button>
                    </div>
                    <ul class="evidence-list" id="evidenceList">
                        <!-- Generated evidence items -->
                    </ul>
                </div>
            </div>

            <!-- Integration Panel -->
            <div class="integration-panel">
                <div class="integration-title">📤 Share with Other Tools</div>
                <div class="integration-links">
                    <a href="/BriefMe/PrepCommand/" class="integration-link" onclick="shareWithPrepCommand()">
                        → PrepCommand
                    </a>
                    <a href="/BriefMe/DialogTools/" class="integration-link" onclick="shareWithDialogTools()">
                        → DialogTools
                    </a>
                    <a href="/Vault/" class="integration-link" onclick="saveToVault()">
                        → Save to Vault
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Privacy Badge -->
    <div class="privacy-badge" id="privacyBadge">
        <svg class="privacy-icon" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 116 0v2h2V7a5 5 0 00-5-5z"/>
        </svg>
        <span id="privacyText">Local Mode (100% Private)</span>
    </div>

    <script type="module">
        // Firebase Configuration (replace with your actual config in production)
        window.firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // State Management
        let currentMode = 'quick';
        let isRecording = false;
        let recordingStartTime = null;
        let recordingTimer = null;
        let generatedContent = {
            opener: '',
            story: '',
            evidence: []
        };
        let voiceRecognition = null;
        let recordingTranscript = '';

        // Initialize Firebase (with graceful fallback)
        let firebaseAvailable = false;
        let auth, db, functions;
        
        async function initializeFirebase() {
            try {
                // Skip Firebase in known local environments
                const isLocalEnvironment = 
                    window.location.hostname === 'localhost' ||
                    window.location.hostname === '127.0.0.1' ||
                    window.location.hostname === '' ||
                    window.location.hostname.includes('claudeusercontent') ||
                    window.location.protocol === 'file:';
                
                if (isLocalEnvironment) {
                    console.log('📱 StoryLab: Running in local mode (Firebase features disabled)');
                    return;
                }
                
                if (window.firebaseConfig && 
                    window.firebaseConfig.apiKey && 
                    window.firebaseConfig.apiKey !== 'YOUR_API_KEY') {
                    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
                    const { getFunctions, httpsCallable } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js');
                    const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
                    const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                    
                    const app = initializeApp(window.firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    functions = getFunctions(app);
                    firebaseAvailable = true;
                    
                    console.log('☁️ StoryLab: Firebase connected successfully');
                }
            } catch (error) {
                // This is expected in many environments, not an error
                console.log('📱 StoryLab: Running in offline mode (all features available locally)');
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();
            loadStoredData();
            initializeVoiceRecognition();
            updateStats();
            updatePrivacyBadge();
            
            // Auto-save draft every 30 seconds
            setInterval(saveDraft, 30000);
        });
        
        // Update privacy badge based on mode
        function updatePrivacyBadge() {
            const badge = document.getElementById('privacyBadge');
            const text = document.getElementById('privacyText');
            
            if (firebaseAvailable) {
                text.textContent = 'Secure Cloud Mode';
                badge.style.background = 'var(--primary-coral)';
            } else {
                text.textContent = 'Local Mode (100% Private)';
                badge.style.background = 'var(--primary-green)';
            }
        }

        // Mode Switching
        window.switchMode = function(mode) {
            currentMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`${mode}ModeBtn`).classList.add('active');
            
            // Show/hide sections
            document.getElementById('quickMode').style.display = mode === 'quick' ? 'block' : 'none';
            document.getElementById('guidedMode').classList.toggle('active', mode === 'guided');
            document.getElementById('powerMode').classList.toggle('active', mode === 'power');
            
            // Save preference
            localStorage.setItem('storylab_mode', mode);
        };

        // Voice Recording
        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                voiceRecognition = new SpeechRecognition();
                voiceRecognition.continuous = true;
                voiceRecognition.interimResults = true;
                voiceRecognition.lang = 'en-US';
                
                voiceRecognition.onresult = (event) => {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        recordingTranscript += finalTranscript + ' ';
                        document.getElementById('storyInput').value = recordingTranscript;
                        showValidationMirror(recordingTranscript);
                    }
                };
                
                voiceRecognition.onerror = (event) => {
                    console.error('Voice recognition error:', event.error);
                    if (isRecording) {
                        stopVoiceRecording();
                        showToast('Voice recording error. Please try typing instead.', 'error');
                    }
                };
            }
        }

        window.toggleVoiceRecording = function() {
            if (isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        };

        function startVoiceRecording() {
            if (!voiceRecognition) {
                showToast('Voice recording not supported in your browser', 'error');
                return;
            }
            
            isRecording = true;
            recordingStartTime = Date.now();
            recordingTranscript = document.getElementById('storyInput').value;
            
            // Update UI
            const btn = document.getElementById('voiceRecordBtn');
            btn.classList.add('recording');
            document.getElementById('recordIcon').textContent = '⏹️';
            document.getElementById('recordText').textContent = 'Stop Recording';
            document.getElementById('recordingIndicator').classList.add('active');
            
            // Start recognition
            voiceRecognition.start();
            
            // Update timer
            recordingTimer = setInterval(updateRecordingTime, 100);
            
            showToast('Recording started. Speak clearly.', 'info');
        }

        function stopVoiceRecording() {
            isRecording = false;
            
            // Stop recognition
            if (voiceRecognition) {
                voiceRecognition.stop();
            }
            
            // Update UI
            const btn = document.getElementById('voiceRecordBtn');
            btn.classList.remove('recording');
            document.getElementById('recordIcon').textContent = '🎤';
            document.getElementById('recordText').textContent = 'Start Voice Recording';
            document.getElementById('recordingIndicator').classList.remove('active');
            
            // Clear timer
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            showToast('Recording stopped', 'success');
        }

        function updateRecordingTime() {
            if (!recordingStartTime) return;
            
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('recordingTime').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Auto-stop at 90 seconds
            if (elapsed >= 90) {
                stopVoiceRecording();
                showToast('Maximum recording time reached (90 seconds)', 'info');
            }
        }

        // Story Generation
        window.generateStory = async function() {
            const input = document.getElementById('storyInput').value.trim();
            
            if (!input) {
                showToast('Please enter your story first', 'error');
                return;
            }
            
            if (input.length < 50) {
                showToast('Please provide more detail for a complete story', 'warning');
                return;
            }
            
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.innerHTML = '<span class="spinner"></span> Generating...';
            generateBtn.disabled = true;
            
            try {
                // Show validation mirror
                showValidationMirror(input);
                
                // Generate with AI
                const result = await generateWithAI(input, 'quick');
                
                // Display results
                displayGeneratedContent(result);
                
                // Save to storage
                await saveToStorage(input, result);
                
                // Update stats
                updateStats();
                
                showToast('Story generated successfully! ✨', 'success');
                
            } catch (error) {
                console.error('Generation error:', error);
                handleGenerationError(error);
            } finally {
                generateBtn.innerHTML = '<span>Generate My Story</span>';
                generateBtn.disabled = false;
            }
        };

        // AI Generation - Try real AI first, then fallback
        async function generateWithAI(input, mode = 'quick', oldcartsData = null) {
            // First, try to use the actual Claude API if available
            try {
                if (window.location.protocol !== 'file:') {
                    return await callClaudeAPI(input, mode, oldcartsData);
                }
            } catch (error) {
                console.log('Using enhanced local generation');
            }
            
            // Fallback to enhanced local generation
            return await enhancedLocalGeneration(input, mode, oldcartsData);
        }
        
        // Call Claude API directly (when available in production)
        async function callClaudeAPI(input, mode, oldcartsData) {
            const prompt = createMedicalNarrativePrompt(input, oldcartsData);
            
            try {
                const response = await fetch('/api/claude', { // You'll need to set up this endpoint
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, mode })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return applyEditorialFilter(data);
                }
            } catch (error) {
                console.log('API not available, using enhanced local generation');
            }
            
            throw new Error('API not available');
        }
        
        function createMedicalNarrativePrompt(input, oldcartsData) {
            let prompt = `Create three medical narratives from this patient story:\n\n`;
            prompt += `Patient's words: "${input}"\n\n`;
            
            if (oldcartsData) {
                prompt += `Additional structured data:\n`;
                Object.entries(oldcartsData).forEach(([key, value]) => {
                    if (value) prompt += `${key}: ${value}\n`;
                });
                prompt += '\n';
            }
            
            prompt += `Generate:
1. A 30-second opener (2-3 sentences max) that clearly states the main concern
2. A 2-minute story (1 paragraph) with complete medical narrative
3. A list of 5-8 objective evidence points

Requirements:
- Use natural, flowing language
- Be specific about symptoms (not just "symptoms")
- Include timeline, severity, and impact
- Maintain the patient's voice while being medically clear
- No repetition or redundancy`;
            
            return prompt;
        }

        // Enhanced Local Generation with better quality
        async function enhancedLocalGeneration(input, mode, oldcartsData) {
            // Simulate realistic processing
            await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 500));
            
            // Parse and understand the input better
            const analysis = comprehensiveAnalysis(input, oldcartsData);
            
            // Generate high-quality narratives
            const rawOutput = {
                opener: generateSmartOpener(analysis),
                story: generateCoherentStory(analysis),
                evidence: generateEvidenceList(analysis)
            };
            
            // Apply editorial filter to clean up any issues
            return applyEditorialFilter(rawOutput);
        }
        
        // Comprehensive analysis with better parsing
        function comprehensiveAnalysis(input, oldcartsData) {
            const analysis = {
                mainSymptom: '',
                symptoms: [],
                location: '',
                timeline: '',
                character: '',
                severity: '',
                patterns: [],
                triggers: [],
                relief: [],
                impacts: [],
                frequency: '',
                progression: '',
                context: ''
            };
            
            // Clean the input
            const text = input.toLowerCase().trim();
            const sentences = text.split(/[.!?]+/).filter(s => s.trim());
            
            // Extract main symptom (the first mentioned or most prominent)
            const symptomMatches = text.match(/\b(pain|ache|headache|migraine|fatigue|nausea|dizziness|discomfort|pressure|tension|soreness|weakness|numbness|tingling|burning|stiffness|swelling)\b/gi);
            if (symptomMatches && symptomMatches.length > 0) {
                analysis.mainSymptom = symptomMatches[0].toLowerCase();
                analysis.symptoms = [...new Set(symptomMatches.map(s => s.toLowerCase()))];
            }
            
            // Extract body location
            const locationMatch = text.match(/\b(in|at|on|around)\s+(my\s+)?(head|neck|back|lower back|upper back|mid back|shoulder|arm|hand|chest|abdomen|stomach|hip|leg|knee|foot|ankle|wrist|elbow|jaw|face|eyes?)\b/i);
            if (locationMatch) {
                analysis.location = locationMatch[2].replace(/^my\s+/, '').trim();
            }
            
            // Extract timeline more intelligently
            const timePatterns = [
                /(\d+)\s*(day|week|month|year)s?\s*ago/i,
                /since\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday|yesterday|last\s+week|last\s+month)/i,
                /for\s+(the\s+past\s+)?(\d+)?\s*(day|week|month|year)s?/i,
                /started\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday|yesterday)/i
            ];
            
            for (const pattern of timePatterns) {
                const match = text.match(pattern);
                if (match) {
                    analysis.timeline = match[0].replace(/^(since|for|started)\s+/, '');
                    break;
                }
            }
            
            // Extract pain character/description
            const characterWords = text.match(/\b(sharp|dull|throbbing|stabbing|burning|aching|crushing|piercing|shooting|electric|pulsing|constant|intermittent|pinching|cramping|tight)\b/gi);
            if (characterWords) {
                analysis.character = [...new Set(characterWords.map(w => w.toLowerCase()))].join(' and ');
            }
            
            // Extract severity
            const severityMatch = text.match(/\b([1-9]|10)\s*(?:\/\s*10|out\s+of\s+10)?\b/);
            if (severityMatch) {
                const score = parseInt(severityMatch[1]);
                if (score <= 3) analysis.severity = `mild (${score}/10)`;
                else if (score <= 6) analysis.severity = `moderate (${score}/10)`;
                else analysis.severity = `severe (${score}/10)`;
            } else if (text.match(/\b(severe|awful|terrible|unbearable|extreme|excruciating)\b/i)) {
                analysis.severity = 'severe';
            } else if (text.match(/\b(moderate|medium|significant)\b/i)) {
                analysis.severity = 'moderate';
            } else if (text.match(/\b(mild|slight|minor)\b/i)) {
                analysis.severity = 'mild';
            }
            
            // Extract triggers/aggravating factors
            const triggerMatches = text.match(/(worse\s+with|triggered\s+by|aggravated\s+by|happens\s+when)\s+([^.,]+)/i);
            if (triggerMatches) {
                analysis.triggers = [triggerMatches[2].trim()];
            }
            
            // Extract relief factors
            const reliefMatches = text.match(/(better\s+with|relief\s+with|helps|improves\s+with)\s+([^.,]+)/i);
            if (reliefMatches) {
                analysis.relief = [reliefMatches[2].trim()];
            }
            
            // Extract progression
            if (text.includes('getting worse') || text.includes('worsening')) {
                analysis.progression = 'worsening';
            } else if (text.includes('getting better') || text.includes('improving')) {
                analysis.progression = 'improving';
            } else if (text.includes('same') || text.includes('stable')) {
                analysis.progression = 'stable';
            }
            
            // Extract patterns
            if (text.includes('morning')) analysis.patterns.push('occurs in the morning');
            if (text.includes('night') || text.includes('sleep')) analysis.patterns.push('affects sleep');
            if (text.includes('activity') || text.includes('movement')) analysis.patterns.push('activity-related');
            if (text.includes('sitting') || text.includes('standing')) analysis.patterns.push('position-dependent');
            
            // Merge with OLD CARTS data if provided
            if (oldcartsData) {
                if (oldcartsData.onset) analysis.timeline = oldcartsData.onset;
                if (oldcartsData.location) analysis.location = oldcartsData.location;
                if (oldcartsData.character) analysis.character = oldcartsData.character;
                if (oldcartsData.severity) analysis.severity = oldcartsData.severity;
                if (oldcartsData.aggravating) analysis.triggers = [oldcartsData.aggravating];
                if (oldcartsData.relieving) analysis.relief = [oldcartsData.relieving];
                if (oldcartsData.timing) analysis.patterns.push(oldcartsData.timing);
            }
            
            return analysis;
        }
        
        // Generate smart, natural opener
        function generateSmartOpener(analysis) {
            let opener = "";
            
            // Build a natural opening based on what we know
            if (analysis.mainSymptom && analysis.timeline && analysis.severity) {
                opener = `I've been experiencing ${analysis.severity} ${analysis.mainSymptom}`;
                if (analysis.location) opener += ` in my ${analysis.location}`;
                opener += ` for ${analysis.timeline}. `;
                
                if (analysis.progression === 'worsening') {
                    opener += `It's been getting worse and I'm concerned about the progression.`;
                } else if (analysis.patterns.length > 0) {
                    opener += `I've noticed it's ${analysis.patterns[0]}, which significantly impacts my daily activities.`;
                } else {
                    opener += `I'm here because I need help managing this condition effectively.`;
                }
            } else if (analysis.mainSymptom && analysis.location) {
                opener = `Thank you for seeing me today. I'm experiencing ${analysis.mainSymptom}`;
                if (analysis.location) opener += ` in my ${analysis.location}`;
                if (analysis.character) opener += ` that feels ${analysis.character}`;
                opener += `. `;
                
                if (analysis.timeline) {
                    opener += `This has been going on for ${analysis.timeline} and I'd like to find relief.`;
                } else {
                    opener += `I'm looking for an effective treatment approach.`;
                }
            } else if (analysis.mainSymptom) {
                opener = `I need help with ${analysis.mainSymptom} that`;
                if (analysis.timeline) opener += ` started ${analysis.timeline}`;
                if (analysis.progression) opener += ` has been ${analysis.progression}`;
                opener += `. I'm hoping we can work together to find a solution.`;
            } else {
                // Generic fallback
                opener = `I'm here to discuss symptoms that have been affecting my quality of life. I'd appreciate your help in finding an effective treatment approach.`;
            }
            
            return opener;
        }
        
        // Generate coherent, flowing story
        function generateCoherentStory(analysis) {
            let story = "";
            
            // Opening - Set the context
            if (analysis.timeline) {
                story += `My symptoms began ${analysis.timeline}. `;
            } else {
                story += `I've been dealing with these symptoms for some time now. `;
            }
            
            // Describe the main symptom and character
            if (analysis.mainSymptom) {
                story += `The primary issue is ${analysis.mainSymptom}`;
                if (analysis.location) {
                    story += ` in my ${analysis.location}`;
                }
                if (analysis.character) {
                    story += `, which feels ${analysis.character}`;
                }
                story += `. `;
            }
            
            // Add secondary symptoms if present
            if (analysis.symptoms.length > 1) {
                const otherSymptoms = analysis.symptoms.filter(s => s !== analysis.mainSymptom);
                if (otherSymptoms.length > 0) {
                    story += `I also experience ${otherSymptoms.join(', ')}. `;
                }
            }
            
            // Describe severity and impact
            if (analysis.severity) {
                story += `The severity is ${analysis.severity}`;
                if (analysis.progression === 'worsening') {
                    story += ` and unfortunately has been getting worse`;
                } else if (analysis.progression === 'improving') {
                    story += ` though it has been slowly improving`;
                } else if (analysis.progression === 'stable') {
                    story += ` and has remained relatively stable`;
                }
                story += `. `;
            }
            
            // Describe patterns and triggers
            if (analysis.patterns.length > 0 || analysis.triggers.length > 0) {
                story += `I've noticed that `;
                if (analysis.patterns.length > 0) {
                    story += `it ${analysis.patterns[0]}`;
                    if (analysis.triggers.length > 0) {
                        story += ` and `;
                    }
                }
                if (analysis.triggers.length > 0) {
                    story += `it gets worse with ${analysis.triggers[0]}`;
                }
                story += `. `;
            }
            
            // Describe what helps
            if (analysis.relief.length > 0) {
                story += `I find some relief with ${analysis.relief[0]}, though the improvement is usually temporary. `;
            }
            
            // Closing - Express goals
            story += `My goal is to `;
            if (analysis.progression === 'worsening') {
                story += `stop this progression and find lasting relief`;
            } else if (analysis.mainSymptom) {
                story += `better manage this ${analysis.mainSymptom} and improve my quality of life`;
            } else {
                story += `find an effective treatment plan that addresses these symptoms`;
            }
            story += `. I'm open to exploring different treatment options and would appreciate your expertise in developing a comprehensive approach.`;
            
            return story;
        }
        
        // Generate evidence list
        function generateEvidenceList(analysis) {
            const evidence = [];
            
            // Always include what we know
            if (analysis.mainSymptom) {
                if (analysis.location) {
                    evidence.push(`Primary complaint: ${analysis.mainSymptom} in ${analysis.location}`);
                } else {
                    evidence.push(`Primary complaint: ${analysis.mainSymptom}`);
                }
            }
            
            if (analysis.timeline) {
                evidence.push(`Onset/Duration: ${analysis.timeline}`);
            }
            
            if (analysis.character) {
                evidence.push(`Character: ${analysis.character}`);
            }
            
            if (analysis.severity) {
                evidence.push(`Severity: ${analysis.severity}`);
            }
            
            if (analysis.progression) {
                evidence.push(`Progression: ${analysis.progression} over time`);
            }
            
            if (analysis.patterns.length > 0) {
                evidence.push(`Patterns: ${analysis.patterns.join(', ')}`);
            }
            
            if (analysis.triggers.length > 0) {
                evidence.push(`Aggravating factors: ${analysis.triggers.join(', ')}`);
            }
            
            if (analysis.relief.length > 0) {
                evidence.push(`Relieving factors: ${analysis.relief.join(', ')}`);
            }
            
            if (analysis.symptoms.length > 1) {
                evidence.push(`Associated symptoms: ${analysis.symptoms.filter(s => s !== analysis.mainSymptom).join(', ')}`);
            }
            
            // Ensure minimum evidence
            while (evidence.length < 3) {
                if (!evidence.some(e => e.includes('Impact'))) {
                    evidence.push(`Impact: Affecting daily activities and quality of life`);
                } else if (!evidence.some(e => e.includes('Treatment goal'))) {
                    evidence.push(`Treatment goal: Seeking effective management strategies`);
                } else {
                    evidence.push(`Medical evaluation: Comprehensive assessment requested`);
                }
            }
            
            return evidence;
        }
        
        // Editorial filter to clean up output
        function applyEditorialFilter(output) {
            // Clean up the opener
            if (output.opener) {
                output.opener = output.opener
                    .replace(/\s+/g, ' ') // Remove extra spaces
                    .replace(/my my/gi, 'my') // Fix double "my"
                    .replace(/\ba\s+([aeiou])/gi, 'an $1') // Fix a/an
                    .replace(/\s+([.,!?])/g, '$1') // Fix punctuation spacing
                    .replace(/^[\s,.-]+|[\s,.-]+$/g, '') // Trim punctuation
                    .trim();
                
                // Ensure it's not too short or incomplete
                if (output.opener.length < 30 || !output.opener.includes(' ')) {
                    output.opener = `I'm experiencing concerning symptoms that have been affecting my daily life. I'm here to discuss treatment options and get your professional assessment.`;
                }
            }
            
            // Clean up the story
            if (output.story) {
                output.story = output.story
                    .replace(/\s+/g, ' ')
                    .replace(/my my/gi, 'my')
                    .replace(/\. \./g, '.')
                    .replace(/\s+([.,!?])/g, '$1')
                    .replace(/([.!?])\s*\1+/g, '$1') // Remove duplicate punctuation
                    .trim();
                
                // Ensure story is complete
                if (output.story.length < 100) {
                    output.story += ` I'm looking forward to working with you to develop an effective treatment plan.`;
                }
                
                // Ensure it ends with proper punctuation
                if (!output.story.match(/[.!?]$/)) {
                    output.story += '.';
                }
            }
            
            // Clean up evidence
            if (output.evidence && Array.isArray(output.evidence)) {
                output.evidence = output.evidence
                    .map(item => item.trim())
                    .filter(item => item.length > 5) // Remove too-short items
                    .map(item => {
                        // Capitalize first letter
                        return item.charAt(0).toUpperCase() + item.slice(1);
                    });
                
                // Remove duplicates
                output.evidence = [...new Set(output.evidence)];
            }
            
            return output;
        }

        // Generate from OLD CARTS
        window.generateFromOLDCARTS = async function() {
            const fields = ['onset', 'location', 'duration', 'character', 'aggravating', 'relieving', 'timing', 'severity'];
            const data = {};
            let hasData = false;
            
            fields.forEach(field => {
                const value = document.getElementById(field).value.trim();
                if (value) {
                    data[field] = value;
                    hasData = true;
                }
            });
            
            if (!hasData) {
                showToast('Please fill in at least one field', 'error');
                return;
            }
            
            // Create narrative from OLD CARTS
            const narrative = createNarrativeFromOLDCARTS(data);
            
            try {
                const result = await generateWithAI(narrative, 'guided', data);
                displayGeneratedContent(result);
                await saveToStorage(narrative, result);
                showToast('Story generated from your details! 🎯', 'success');
            } catch (error) {
                handleGenerationError(error);
            }
        };

        function createNarrativeFromOLDCARTS(data) {
            const parts = [];
            
            if (data.onset) parts.push(`This started ${data.onset}`);
            if (data.location) parts.push(`The symptoms are located in ${data.location}`);
            if (data.character) parts.push(`It feels like ${data.character}`);
            if (data.duration) parts.push(`Episodes typically last ${data.duration}`);
            if (data.timing) parts.push(`It occurs ${data.timing}`);
            if (data.aggravating) parts.push(`It gets worse with ${data.aggravating}`);
            if (data.relieving) parts.push(`It improves with ${data.relieving}`);
            if (data.severity) parts.push(`The severity is ${data.severity}`);
            
            return parts.join('. ') + '.';
        }

        // Display Generated Content
        function displayGeneratedContent(result) {
            generatedContent = result;
            
            // Show output container
            document.getElementById('outputContainer').style.display = 'block';
            
            // Populate content
            document.getElementById('openerContent').textContent = result.opener;
            document.getElementById('storyContent').textContent = result.story;
            
            // Populate evidence list
            const evidenceList = document.getElementById('evidenceList');
            evidenceList.innerHTML = '';
            
            result.evidence.forEach(item => {
                const li = document.createElement('li');
                li.className = 'evidence-item';
                li.innerHTML = `
                    <div class="evidence-bullet"></div>
                    <div class="evidence-text">${item}</div>
                `;
                evidenceList.appendChild(li);
            });
            
            // Scroll to results
            document.getElementById('outputContainer').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        // Show Validation Mirror
        function showValidationMirror(text) {
            const mirror = document.getElementById('validationMirror');
            const content = document.getElementById('validationContent');
            
            content.textContent = text;
            mirror.style.display = 'block';
        }

        // Copy to Clipboard
        window.copyToClipboard = async function(type) {
            let text = '';
            
            switch (type) {
                case 'opener':
                    text = generatedContent.opener;
                    break;
                case 'story':
                    text = generatedContent.story;
                    break;
                case 'evidence':
                    text = generatedContent.evidence.map(e => `• ${e}`).join('\n');
                    break;
            }
            
            if (!text) {
                showToast('No content to copy', 'error');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(text);
                showToast('Copied to clipboard! 📋', 'success');
            } catch (error) {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Copied to clipboard! 📋', 'success');
            }
        };

        // Storage Functions
        async function saveToStorage(input, result) {
            const data = {
                tool: 'StoryLab',
                timestamp: new Date().toISOString(),
                mode: currentMode,
                input: input,
                generated: result,
                version: 'storylab_v2'
            };
            
            // Save locally
            localStorage.setItem('storylab_latest', JSON.stringify(data));
            
            // Save to integration storage
            const integrationData = {
                from: 'StoryLab',
                stories: {
                    opener: result.opener,
                    full: result.story,
                    evidence: result.evidence
                },
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('briefme_storylab_export', JSON.stringify(integrationData));
            
            // Save to Firebase if available
            if (firebaseAvailable && db) {
                try {
                    const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                    const userId = await getUserId();
                    
                    await addDoc(collection(db, 'storylab_stories'), {
                        ...data,
                        userId: userId,
                        privacy: 'private' // Fort Knox mode by default
                    });
                    
                    console.log('Saved to Firebase');
                } catch (error) {
                    console.error('Firebase save error:', error);
                }
            }
        }

        function loadStoredData() {
            const stored = localStorage.getItem('storylab_latest');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    if (data.input) {
                        document.getElementById('storyInput').value = data.input;
                    }
                    if (data.generated) {
                        displayGeneratedContent(data.generated);
                    }
                } catch (error) {
                    console.error('Error loading stored data:', error);
                }
            }
            
            // Load mode preference
            const savedMode = localStorage.getItem('storylab_mode');
            if (savedMode) {
                switchMode(savedMode);
            }
        }

        function saveDraft() {
            const input = document.getElementById('storyInput').value;
            if (input) {
                localStorage.setItem('storylab_draft', input);
            }
        }

        // Clear Functions
        window.clearAndReset = function() {
            if (confirm('This will clear all current content. Continue?')) {
                document.getElementById('storyInput').value = '';
                document.getElementById('validationMirror').style.display = 'none';
                document.getElementById('outputContainer').style.display = 'none';
                generatedContent = { opener: '', story: '', evidence: [] };
                recordingTranscript = '';
                showToast('Content cleared', 'info');
            }
        };

        window.clearOLDCARTS = function() {
            const fields = ['onset', 'location', 'duration', 'character', 'aggravating', 'relieving', 'timing', 'severity'];
            fields.forEach(field => {
                document.getElementById(field).value = '';
            });
            showToast('Form cleared', 'info');
        };

        // Integration Functions
        window.shareWithPrepCommand = function() {
            localStorage.setItem('briefme_storylab_to_prepcommand', JSON.stringify(generatedContent));
            showToast('Story shared with PrepCommand', 'success');
            return false; // Prevent navigation for demo
        };

        window.shareWithDialogTools = function() {
            localStorage.setItem('briefme_storylab_to_dialogtools', JSON.stringify(generatedContent));
            showToast('Story shared with DialogTools', 'success');
            return false;
        };

        window.saveToVault = async function() {
            await saveToStorage(document.getElementById('storyInput').value, generatedContent);
            showToast('Saved to your Vault', 'success');
            return false;
        };

        // Power User Features
        window.analyzePatterns = async function() {
            showToast('Analyzing patterns in your story...', 'info');
            // Implementation would analyze stored stories for patterns
            setTimeout(() => {
                showToast('Pattern analysis complete', 'success');
            }, 2000);
        };

        window.compareStories = function() {
            showToast('Story comparison feature coming soon', 'info');
        };

        window.exportData = function() {
            const exportData = {
                stories: generatedContent,
                timestamp: new Date().toISOString(),
                mode: currentMode
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `storylab_export_${Date.now()}.json`;
            a.click();
            
            showToast('Data exported successfully', 'success');
        };

        window.importFromVault = function() {
            showToast('Importing from Vault...', 'info');
            // Implementation would load previous stories from vault
        };

        window.generateTimeline = function() {
            showToast('Generating timeline visualization...', 'info');
            // Implementation would create visual timeline
        };

        window.smartSuggestions = function() {
            showToast('Generating smart suggestions...', 'info');
            // Implementation would provide AI-powered suggestions
        };

        // Stats Functions
        function updateStats() {
            const stats = getStoredStats();
            document.getElementById('storiesGenerated').textContent = stats.count;
            document.getElementById('avgTime').textContent = stats.avgTime;
            document.getElementById('successRate').textContent = stats.successRate;
        }

        function getStoredStats() {
            const stored = localStorage.getItem('storylab_stats');
            if (stored) {
                return JSON.parse(stored);
            }
            return {
                count: 0,
                avgTime: '3.8',
                successRate: '94%'
            };
        }

        // Utility Functions
        async function getUserId() {
            if (auth && auth.currentUser) {
                return auth.currentUser.uid;
            }
            // Return anonymous ID for local storage
            let userId = localStorage.getItem('briefme_user_id');
            if (!userId) {
                userId = 'anon_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('briefme_user_id', userId);
            }
            return userId;
        }

        function handleGenerationError(error) {
            if (error.message.includes('too long')) {
                showToast('Your input is too long. Please shorten it.', 'error');
            } else if (error.message.includes('rate limit')) {
                showToast('Too many requests. Please wait a moment.', 'error');
            } else {
                showToast('Unable to generate story. Please try again.', 'error');
            }
        }

        // Toast Notifications
        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✓',
                error: '✗',
                warning: '⚠',
                info: 'ℹ'
            };
            
            toast.innerHTML = `
                <span style="font-size: 20px;">${icons[type]}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        };

        // Export for integration
        window.StoryLabExport = {
            getCurrentStories: () => generatedContent,
            hasGeneratedContent: () => generatedContent.opener || generatedContent.story,
            getLastInput: () => document.getElementById('storyInput').value,
            getMode: () => currentMode
        };
    </script>
</body>
</html>