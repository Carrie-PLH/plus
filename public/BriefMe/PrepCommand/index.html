<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PrepCommand - PatientLead+ Appointment Command Center</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<!-- html2pdf.js for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

<style>
  /* ===== Brand Colors ===== */
  :root{
    /* Main Brand Colors */
    --primary-green:#a3b9a3; /* Soft Sage */
    --primary-coral:#c97f6d; /* Warm Clay */
    --dark-accent:#3c5c5e;   /* Piney Green */
    --light-accent:#ebf0eb;  /* Lightest Mint */
    --light-pink:#ecd1cb;    /* Light Pink */
    /* Accents */
    --dusty-teal:#669999;
    --mossy-green:#687744;
    --terra-cotta:#c2552a;   /* Muted Terra Cotta */
    /* Darkened variants */
    --dark-sage:#8fa38f;
    --dark-clay:#b56f5d;
    --darker-piney:#2a4244;
    /* Semantics */
    --warning-amber:#c2552a;
    --success-green:#687744;
    --info-blue:#669999;
    /* UI */
    --text-dark:#333;
    --text-light:#666;
    --white:#fff;
    --border-color:#e0e0e0;
    --focus-color:#3c5c5e;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Roboto',sans-serif;
    font-size:16px;
    line-height:1.6;
    color:var(--text-dark);
    background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);
    min-height:100vh;
    padding:20px;
  }
  .container{max-width:1000px;margin:0 auto}

  /* Header */
  .header{
    position:relative;
    background:var(--white);
    padding:25px;border-radius:12px;
    box-shadow:0 2px 10px rgba(0,0,0,.1);
    margin-bottom:25px;
  }
  .header h1{
    color:var(--dark-accent);font-size:32px;margin-bottom:10px;
    display:flex;align-items:center;gap:15px;
  }
  .header .subtitle{color:var(--text-light);font-size:18px}

  /* Mode Switcher */
  .mode-switcher{
    display:flex;gap:10px;margin:25px 0;background:var(--white);
    padding:15px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,.05);
  }
  .mode-button{
    flex:1;padding:15px 25px;border:2px solid var(--border-color);
    background:var(--white);border-radius:8px;cursor:pointer;
    transition:.3s;text-align:center;
  }
  .mode-button:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
  .mode-button.active{background:var(--primary-green);color:var(--white);border-color:var(--primary-green)}
  .mode-button h3{margin:0 0 5px 0;font-size:18px}
  .mode-button p{margin:0;font-size:14px;opacity:.9}

  /* Cards & content */
  .main-content{background:var(--white);padding:30px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.1);margin-bottom:25px}
  .visit-context{background:var(--white);padding:25px;border-radius:12px;border:1px solid var(--border-color);box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:20px}
  .visit-context-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px}
  .context-field{display:flex;flex-direction:column}
  .context-field label{font-size:14px;color:var(--text-light);margin-bottom:5px}
  .context-field input,.context-field select{
    padding:10px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;background:var(--white)
  }

  /* Progress */
  .progress-container{background:var(--white);padding:20px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,.05);margin-bottom:20px}
  .progress-bar{height:8px;background:var(--light-accent);border-radius:4px;overflow:hidden;margin-bottom:10px}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--primary-green) 0%,var(--dusty-teal) 100%);border-radius:4px;transition:width .3s;width:0%}
  .progress-text{text-align:center;color:var(--text-light);font-size:14px}
  .progress-container.success-animation{animation:successPulse .3s ease}
  @keyframes successPulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}

  .section-card{
    background:var(--white);border:1px solid var(--border-color);border-radius:12px;
    padding:25px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.05);position:relative;transition:.3s
  }
  .section-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.08)}
  .section-card.completed{border-color:var(--mossy-green);background:linear-gradient(to right,rgba(163,185,163,.05) 0%,transparent 100%)}
  .section-card.completed::after{
    content:'‚úì';position:absolute;top:20px;right:20px;background:var(--mossy-green);color:#fff;
    width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold
  }
  .section-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid var(--light-accent)}
  .section-header h2{color:var(--dark-accent);font-size:22px;margin:0;flex:1}
  .section-number{background:var(--light-accent);color:var(--dark-accent);width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}

  /* Concerns */
  .concerns-section{margin-bottom:25px}
  .concerns-section h2{color:var(--dark-accent);margin-bottom:15px;display:flex;align-items:center;gap:10px}
  .concern-card{background:var(--white);border:2px solid var(--border-color);border-radius:8px;padding:20px;margin-bottom:15px;position:relative;transition:.3s}
  .concern-card:hover{border-color:var(--primary-green);box-shadow:0 4px 12px rgba(163,185,163,.2)}
  .concern-card.priority-1{border-left:5px solid var(--primary-coral)}
  .concern-card.priority-2{border-left:5px solid var(--warning-amber)}
  .concern-card.priority-3{border-left:5px solid var(--info-blue)}
  .concern-number{position:absolute;top:10px;right:15px;background:var(--light-accent);width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--dark-accent)}
  .concern-input{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;margin-bottom:10px}

  .severity-selector{display:flex;gap:10px;margin-bottom:10px;border:none;padding:0}
  .severity-btn{padding:8px 15px;border:1px solid var(--border-color);background:var(--white);border-radius:6px;cursor:pointer;transition:.2s;font-size:14px;font-weight:500}
  .severity-btn:hover{background:var(--light-accent);transform:translateY(-1px)}
  .severity-btn.selected,.severity-btn[aria-pressed="true"]{background:var(--dusty-teal);color:#fff;border-color:var(--dusty-teal)}

  .ai-suggestion{
    background: linear-gradient(135deg, #c2552a 0%, #c97f6d 100%);color:#fff;padding:10px 15px;border-radius:6px;font-size:14px;
    margin-top:10px;display:none;animation:slideIn .3s ease
  }
  .ai-suggestion.visible{display:block}
  @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

  /* Key Question & Opening */
  .key-question{background:var(--primary-coral);color:#fff;padding:25px}
  .key-question .section-header{border-bottom-color:rgba(255,255,255,.2)}
  .key-question .section-number{background:rgba(255,255,255,.2);color:#fff}
  .key-question textarea{
    width:100%;padding:15px;border:none;border-radius:6px;font-size:16px;min-height:80px;resize:vertical;background:rgba(255,255,255,.95);color:var(--text-dark)
  }

  .opening-line{background:var(--dark-accent);color:#fff;padding:25px}
  .opening-line .section-header{border-bottom-color:rgba(255,255,255,.2)}
  .opening-line .section-number{background:rgba(255,255,255,.2);color:#fff}
  .opening-line-input{
    width:100%;padding:15px;border:none;border-radius:6px;font-size:18px;font-style:italic;background:rgba(255,255,255,.95);color:var(--text-dark)
  }
  .regenerate-btn{
    margin-top:10px;padding:10px 20px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);
    border-radius:6px;cursor:pointer;transition:.3s
  }
  .regenerate-btn:hover{background:rgba(255,255,255,.3)}

  /* Comprehensive */
  .comprehensive-mode{display:none}
  .comprehensive-mode.active{display:block}
  .timeline-item{display:flex;align-items:center;gap:15px;margin-bottom:15px;padding:15px;background:#fff;border-radius:6px;border:1px solid var(--border-color)}
  .timeline-time{font-weight:700;color:var(--dusty-teal);min-width:80px}
  .timeline-topic{flex:1}
  .timeline-priority{padding:5px 10px;border-radius:4px;font-size:12px;font-weight:700;text-transform:uppercase}
  .priority-must{background:var(--terra-cotta);color:#fff}
  .priority-should{background:var(--primary-coral);color:#fff}
  .priority-could{background:var(--dusty-teal);color:#fff}

  /* Contingency */
  .contingency-section.section-card{background:var(--light-pink);border-left:4px solid var(--terra-cotta)}
  .scenario-card{background:#fff;padding:15px;border-radius:6px;margin-bottom:15px}
  .response-script{background:var(--light-accent);padding:15px;border-radius:6px;font-style:italic;border-left:3px solid var(--primary-green)}

  /* Buttons */
  .action-buttons{display:flex;gap:15px;flex-wrap:wrap;margin-top:30px}
  .btn{padding:15px 30px;border:none;border-radius:8px;font-size:16px;font-weight:500;cursor:pointer;transition:.3s;text-decoration:none;display:inline-flex;align-items:center;gap:10px}
  .btn-primary{background:var(--mossy-green);color:#fff}
  .btn-primary:hover{background:var(--dark-accent);transform:translateY(-2px);box-shadow:0 4px 12px rgba(104,119,68,.3)}
  .btn-secondary{background:#fff;color:var(--dark-accent);border:2px solid var(--primary-green)}
  .btn-secondary:hover{background:var(--light-accent)}
  .btn-coral{background:var(--primary-coral);color:#fff}
  .btn-coral:hover{background:var(--terra-cotta)}

  /* Visit Companion */
  .mobile-companion{
    position:fixed;bottom:20px;right:20px;width:320px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.2);
    padding:20px;display:none;z-index:1000
  }
  .mobile-companion.active{display:block}
  .companion-header{
    display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:15px;border-bottom:2px solid var(--light-accent)
  }
  .visit-timer{background:var(--dusty-teal);color:#fff;padding:5px 15px;border-radius:20px;font-weight:700;font-size:14px}
  .companion-current{background:var(--primary-green);color:#fff;padding:15px;border-radius:8px;margin-bottom:15px}
  .companion-current h4{margin-bottom:5px}
  .companion-next{background:var(--light-accent);padding:15px;border-radius:8px;margin-bottom:15px}
  .companion-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .companion-btn{padding:12px;border:1px solid var(--border-color);background:#fff;border-radius:6px;cursor:pointer;text-align:center;transition:.2s}
  .companion-btn:hover{background:var(--light-accent)}
  .companion-btn.emergency{background:var(--primary-coral);color:#fff;border-color:var(--primary-coral)}

  /* Preview */
  .preview-panel{background:#fff;padding:30px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.1);margin-bottom:25px;display:none}
  .preview-panel.active{display:block}
  .preview-header{text-align:center;padding-bottom:20px;border-bottom:3px solid var(--primary-green);margin-bottom:25px}
  .preview-content{font-family:'Georgia',serif;line-height:1.8}
  .preview-section{margin-bottom:25px;padding:20px;background:var(--light-accent);border-radius:8px;break-inside:avoid;page-break-inside:avoid}
  .preview-section h3{color:var(--dark-accent);margin-bottom:15px;font-size:20px;border-bottom:2px solid var(--primary-green);padding-bottom:10px}
  @media print{
    body{background:#fff;padding:0}
    .header,.mode-switcher,.action-buttons,.mobile-companion,.regenerate-btn{display:none!important}
    .main-content{box-shadow:none;padding:20px}
    .preview-panel{display:block!important}
  }

  /* A11y & helpers */
  .skip-link{position:absolute;top:-40px;left:0;background:var(--dark-accent);color:#fff;padding:8px;text-decoration:none;z-index:100}
  .skip-link:focus{top:0}
  *:focus{outline:3px solid var(--focus-color);outline-offset:2px}
  button:focus,.severity-btn:focus{outline:3px solid var(--focus-color);outline-offset:2px;box-shadow:0 0 0 4px rgba(60,92,94,.1)}
  input:focus,select:focus,textarea:focus{outline:3px solid var(--focus-color);border-color:var(--focus-color);box-shadow:0 0 0 4px rgba(60,92,94,.1)}

  /* Toast */
  .toast{
    position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
    background:var(--dusty-teal);color:#fff;padding:10px 16px;border-radius:8px;
    opacity:0;visibility:hidden;transition:opacity .2s,visibility .2s;z-index:2000
  }
  .toast.show{opacity:1;visibility:visible}
  .toast.success{background:var(--mossy-green)}
  .toast.error{background:var(--terra-cotta)}
  .toast.info{background:var(--dusty-teal)}

  /* Mobile tweaks */
  @media (max-width:768px){
    body{padding:10px}
    .header h1{font-size:24px;flex-direction:column;align-items:flex-start}
    .header .subtitle{font-size:14px}
    .mode-switcher{flex-direction:column}
    .visit-context-grid{grid-template-columns:1fr;gap:20px}
    .severity-selector{flex-wrap:wrap;gap:8px}
    .severity-btn{min-width:70px;min-height:44px;font-size:14px}
    .action-buttons{flex-direction:column;gap:12px}
    .btn{width:100%;justify-content:center;min-height:48px;font-size:16px}
    .concern-input,input[type="text"],select,textarea{font-size:16px;min-height:44px}
    .mobile-companion{width:calc(100% - 20px);left:10px;right:10px;bottom:10px;max-height:80vh;overflow-y:auto}
    .companion-actions{grid-template-columns:1fr 1fr;gap:8px}
    .companion-btn{min-height:44px;font-size:14px}
    .section-card{padding:20px 15px}
    .progress-container{padding:15px}
  }
</style>
</head>
<body>
<a href="#quickMode" class="skip-link">Skip to main content</a>

<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>PrepCommand</h1>
    <p class="subtitle">Lead every appointment with clarity and confidence to achieve better care</p>
    <button onclick="toggleClinicSafe()" style="position:absolute;top:20px;right:20px;padding:8px 15px;border:1px solid var(--border-color);background:#fff;border-radius:6px;cursor:pointer;font-size:14px;">üè• Clinic-Safe Mode</button>
  </div>

  <!-- Mode Switcher -->
  <div class="mode-switcher">
    <button class="mode-button active" onclick="switchMode('quick', event)">
      <h3>‚ö° Quick Mode</h3>
      <p>2-minute prep for any appointment</p>
    </button>
    <button class="mode-button" onclick="switchMode('comprehensive', event)">
      <h3>üìã Comprehensive Mode</h3>
      <p>Full agenda with time allocation & contingencies</p>
    </button>
    <button class="mode-button" onclick="switchMode('companion', event)">
      <h3>üì± Visit Companion</h3>
      <p>Real-time support during your appointment</p>
    </button>
  </div>

  <!-- Quick Mode -->
  <div class="main-content quick-mode active" id="quickMode">
    <!-- Visit Context -->
    <div class="visit-context" id="section-context">
      <h2>Visit Context</h2>
      <div class="visit-context-grid">
        <div class="context-field">
          <label for="visitType">Visit Type</label>
          <select id="visitType" onchange="updateVisitType()">
            <option value="initial" selected>Initial Consultation</option>
            <option value="followup">Follow-up</option>
            <option value="urgent">Urgent/Same-day</option>
            <option value="medication">Medication Management</option>
            <option value="insurance">Insurance/Authorization</option>
            <option value="second">Second Opinion</option>
          </select>
        </div>
        <div class="context-field">
          <label for="provider">Provider/Specialty</label>
          <input type="text" id="provider" placeholder="e.g., Dr. Smith, Rheumatology"/>
        </div>
        <div class="context-field">
          <label for="appointmentDate">Date & Time</label>
          <input type="datetime-local" id="appointmentDate"/>
        </div>
        <div class="context-field">
          <label for="duration">Expected Duration</label>
          <select id="duration">
            <option value="15">15 minutes</option>
            <option value="30" selected>30 minutes</option>
            <option value="45">45 minutes</option>
            <option value="60">60 minutes</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Concerns -->
    <div class="concerns-section" id="section-concerns">
      <h2><span>üéØ</span> My Top 3 Concerns</h2>

      <div class="concern-card priority-1">
        <span class="concern-number">1</span>
        <input type="text" class="concern-input" id="concern1" placeholder="Most important issue to address today"/>
        <div class="severity-selector" role="group" aria-label="Severity for concern 1">
          <button class="severity-btn" onclick="setSeverity(1,'mild',event)">Mild</button>
          <button class="severity-btn" onclick="setSeverity(1,'moderate',event)">Moderate</button>
          <button class="severity-btn selected" aria-pressed="true" onclick="setSeverity(1,'severe',event)">Severe</button>
          <button class="severity-btn" onclick="setSeverity(1,'crisis',event)">Crisis</button>
        </div>
        <div class="ai-suggestion" id="suggestion1">üí° AI: Consider mentioning how this affects your daily activities</div>
      </div>

      <div class="concern-card priority-2">
        <span class="concern-number">2</span>
        <input type="text" class="concern-input" id="concern2" placeholder="Secondary concern"/>
        <div class="severity-selector" role="group" aria-label="Severity for concern 2">
          <button class="severity-btn" onclick="setSeverity(2,'mild',event)">Mild</button>
          <button class="severity-btn selected" aria-pressed="true" onclick="setSeverity(2,'moderate',event)">Moderate</button>
          <button class="severity-btn" onclick="setSeverity(2,'severe',event)">Severe</button>
          <button class="severity-btn" onclick="setSeverity(2,'crisis',event)">Crisis</button>
        </div>
        <div class="ai-suggestion" id="suggestion2">üí° AI: Link this to symptom patterns from TrendTrack</div>
      </div>

      <div class="concern-card priority-3">
        <span class="concern-number">3</span>
        <input type="text" class="concern-input" id="concern3" placeholder="Additional concern or administrative need"/>
        <div class="severity-selector" role="group" aria-label="Severity for concern 3">
          <button class="severity-btn selected" aria-pressed="true" onclick="setSeverity(3,'mild',event)">Mild</button>
          <button class="severity-btn" onclick="setSeverity(3,'moderate',event)">Moderate</button>
          <button class="severity-btn" onclick="setSeverity(3,'severe',event)">Severe</button>
          <button class="severity-btn" onclick="setSeverity(3,'admin',event)">Admin</button>
        </div>
        <div class="ai-suggestion" id="suggestion3">üí° AI: Remember to request documentation or referrals if needed</div>
      </div>
    </div>

    <!-- Key Question -->
    <div class="section-card key-question" id="section-question">
      <div class="section-header"><span class="section-number">4</span><h2>My Key Question</h2></div>
      <textarea id="keyQuestion" placeholder="What's the ONE question you MUST get answered today?"></textarea>
      <button class="regenerate-btn" onclick="generateQuestion()">üîÑ Generate AI Question</button>
    </div>

    <!-- Opening Line -->
    <div class="section-card opening-line" id="section-opening">
      <div class="section-header"><span class="section-number">5</span><h2>My Opening Line</h2></div>
      <input type="text" class="opening-line-input" id="openingLine" value="Thank you for seeing me today. I have three main concerns I'd like to discuss, starting with..."/>
      <button class="regenerate-btn" onclick="generateOpening()">üîÑ Generate New Opening</button>
    </div>

    <!-- Actions -->
    <div class="action-buttons">
      <button class="btn btn-primary" onclick="generatePrep()">‚ú® Generate Visit Prep</button>
      <button class="btn btn-secondary" onclick="viewPreview()">üëÅÔ∏è Preview One-Pager</button>
      <button class="btn btn-coral" onclick="exportPDF()">üìÑ Export PDF</button>
      <button class="btn btn-secondary" onclick="openCompanion()">üì± Open Companion</button>
      <button class="btn btn-secondary" onclick="textToPhone()">üí¨ Text to Phone</button>
      <button class="btn btn-secondary" onclick="shareWithAdvocate()">üë• Share with Advocate</button>
    </div>
  </div>

  <!-- Comprehensive Mode -->
  <div class="main-content comprehensive-mode" id="comprehensiveMode">
    <h2 style="margin-bottom:25px;color:var(--dark-accent)">Comprehensive Agenda Builder</h2>

    <div class="section-card">
      <div class="section-header"><span class="section-number">1</span><h2>Visit Timeline Allocation</h2></div>
      <div id="timelineItems">
        <div class="timeline-item"><span class="timeline-time">0-2 min</span><div class="timeline-topic">Opening & Chief Complaint</div><span class="timeline-priority priority-must">Must Do</span></div>
        <div class="timeline-item"><span class="timeline-time">2-10 min</span><div class="timeline-topic">Primary Concern Discussion</div><span class="timeline-priority priority-must">Must Do</span></div>
        <div class="timeline-item"><span class="timeline-time">10-15 min</span><div class="timeline-topic">Secondary Concerns</div><span class="timeline-priority priority-should">Should Do</span></div>
        <div class="timeline-item"><span class="timeline-time">15-18 min</span><div class="timeline-topic">Questions & Clarifications</div><span class="timeline-priority priority-should">Should Do</span></div>
        <div class="timeline-item"><span class="timeline-time">18-20 min</span><div class="timeline-topic">Next Steps & Follow-up</div><span class="timeline-priority priority-must">Must Do</span></div>
      </div>
      <button class="btn btn-secondary" onclick="addTimelineItem()" style="margin-top:15px">+ Add Timeline Item</button>
    </div>

    <div class="section-card contingency-section">
      <div class="section-header"><span class="section-number">2</span><h2>Contingency Plans</h2></div>

      <div class="scenario-card">
        <h4>If Time is Limited</h4>
        <div class="response-script">
          "I understand we're short on time. Let me focus on my most pressing concern about [PRIMARY].
          Can we schedule a follow-up for my other concerns, or should I message through the portal?"
        </div>
      </div>

      <div class="scenario-card">
        <h4>If Dismissed or Minimized</h4>
        <div class="response-script">
          "I appreciate your perspective, but this is significantly impacting my quality of life.
          I've documented [SPECIFIC EVIDENCE]. What criteria would indicate we need to investigate further?"
        </div>
      </div>

      <div class="scenario-card">
        <h4>If Rushed Through</h4>
        <div class="response-script">
          "I have a few more important points. Would it be better to extend today's visit or schedule
          a follow-up? I want to make sure we address everything properly."
        </div>
      </div>

      <div class="scenario-card">
        <h4>Data-Forward Response</h4>
        <div class="response-script">
          "My symptom diary shows this pattern 4‚Äì5 times per week with increasing severity over the past 3 months.
          How does this documented progression change our next steps?"
        </div>
      </div>
    </div>

    <div class="section-card" style="background:var(--light-accent)">
      <div class="section-header"><span class="section-number">3</span><h2>Decision Tree Navigator</h2></div>
      <div style="padding:15px;background:#fff;border-radius:6px">
        <p><strong>If provider suggests "wait and see":</strong></p>
        <ul style="margin-left:20px;margin-top:10px">
          <li>Ask: "What specific timeline should we wait?"</li>
          <li>Ask: "What symptoms would indicate we shouldn't wait?"</li>
          <li>Ask: "Can we schedule a follow-up now to reassess?"</li>
        </ul>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-primary" onclick="generateFullAgenda()">üìã Generate Full Agenda</button>
      <button class="btn btn-secondary" onclick="printAgendaCard()">üé´ Print Agenda Card</button>
      <button class="btn btn-secondary" onclick="switchMode('quick', event)">‚ö° Switch to Quick Mode</button>
    </div>
  </div>

  <!-- Visit Companion -->
  <div class="mobile-companion" id="mobileCompanion" aria-modal="true" role="dialog">
    <div class="companion-header">
      <h3>Visit Companion</h3>
      <div class="visit-timer" id="visitTimer">30:00</div>
      <button onclick="closeCompanion()" style="background:none;border:none;font-size:24px;cursor:pointer" aria-label="Close companion view">√ó</button>
    </div>

    <div class="companion-current">
      <h4>Current Topic</h4>
      <div id="currentTopic">Opening statement</div>
      <button class="companion-btn" style="background:#fff;color:var(--primary-green);margin-top:10px;">‚úì Discussed</button>
    </div>

    <div class="companion-next">
      <h4>Next Up</h4>
      <div id="nextTopic">Primary concern discussion</div>
    </div>

    <div class="companion-actions">
      <button class="companion-btn" onclick="goBack()">‚Ü©Ô∏è Back</button>
      <button class="companion-btn" onclick="needPhrase()">üí¨ Need a phrase?</button>
      <button class="companion-btn" onclick="recordNote()">üéôÔ∏è Record Note</button>
      <button class="companion-btn" onclick="groundingBreak()">‚è∏Ô∏è Grounding</button>
      <button class="companion-btn" onclick="flagForFollowup()">üö© Flag Item</button>
      <button class="companion-btn emergency" onclick="dataForward()">üìä Use My Data</button>
    </div>
  </div>

  <!-- Preview Panel -->
  <div class="preview-panel" id="previewPanel">
    <div class="preview-header">
      <h1>VISIT READY</h1>
      <p id="previewMeta">[Specialty] - Dr. [Name] - [Date]</p>
    </div>

    <div class="preview-content">
      <div class="preview-section">
        <h3>MY FOCUS TODAY</h3>
        <ol id="previewFocus">
          <li>[Primary concern with severity]</li>
          <li>[Secondary concern]</li>
          <li>[Tertiary concern or admin need]</li>
        </ol>
      </div>

      <div class="preview-section">
        <h3>MY STORY (2 minutes)</h3>
        <p id="previewStory">[6-sentence clinical summary using OLD CARTS format]</p>
      </div>

      <div class="preview-section">
        <h3>KEY EVIDENCE</h3>
        <ul id="previewEvidence">
          <li>[Symptom diary finding]</li>
          <li>[Test result if relevant]</li>
          <li>[Previous treatment tried]</li>
        </ul>
      </div>

      <div class="preview-section" style="background:var(--light-accent)">
        <h3>MY QUESTIONS</h3>
        <ol id="previewQuestions">
          <li>"[Primary diagnostic or treatment question]"</li>
          <li>"[Secondary clarification]"</li>
          <li>"[Follow-up planning question]"</li>
        </ol>
      </div>

      <div class="preview-section" style="background:var(--light-pink);border-left:4px solid var(--terra-cotta)">
        <h3>CONTINGENCY PLANS</h3>
        <p><strong>IF TIME LIMITED:</strong> Focus on [primary] + [critical need]</p>
        <p><strong>IF DISMISSED:</strong> "[Prepared assertive response]"</p>
        <p><strong>IF RUSHED:</strong> Request portal follow-up for remaining concerns</p>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>
</div>

<!-- ============ JavaScript (single module, no duplicates) ============ -->
<script type="module">
/* ---------- i18n ---------- */
const strings = {
  en:{
    switchedMode:'Switched to {mode} mode',
    generatingQuestion:'Generating AI question...',
    questionGenerated:'Question generated!',
    generatingOpening:'Generating opening...',
    openingGenerated:'Opening generated!',
    generatingPrep:'Creating your personalized visit prep...',
    prepComplete:'Visit prep complete! Review your one-pager below',
    generatingPDF:'Generating PDF...',
    pdfDownloaded:'PDF saved to your downloads!',
    pdfError:'Error generating PDF',
    textFeatureComing:'Text feature will open your messaging app',
    sharedSuccess:'Shared successfully!',
    linkCopied:'Link copied to clipboard!',
    voiceStarted:'Voice recording started...',
    groundingPrompt:'Notice 5 things you see, 4 you hear, 3 you feel...',
    flaggedFollowup:'Flagged for follow-up: {item}',
    savedVault:'Data saved successfully!',
    errorSaving:'Error saving data',
    generatingAgenda:'Generating comprehensive agenda...',
    agendaGenerated:'Full agenda generated!',
    autoSaved:'Changes auto-saved',
    needPhraseHelps:[
      'Try: "I need a moment to check my notes."',
      'Say: "Can you clarify what you mean by that?"',
      'Ask: "How does this connect to my symptoms?"',
      'Say: "Let me make sure I understand correctly..."'
    ],
    dataForwardPrompt:'Say: "My symptom diary shows [pattern]. How does this data change our approach?"'
  }
};
let currentLang='en';
const t=(k,params={})=>{
  let s=strings[currentLang][k]||k;
  Object.keys(params).forEach(p=>{s=s.replace(`{${p}}`,params[p]);});
  return s;
};

/* ---------- Firebase (graceful fallback) ---------- */
let firebaseAvailable=false; let auth,db,functions;
try{
  if(window.location.hostname!=='claudeusercontent.com' && window.firebaseConfig){
    const {initializeApp}=await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
    const {getFunctions}=await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js');
    const {getAuth}=await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
    const {getFirestore}=await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    const app=initializeApp(window.firebaseConfig);
    auth=getAuth(app); db=getFirestore(app); functions=getFunctions(app);
    firebaseAvailable=true;
  }
}catch{}

/* ---------- State ---------- */
let currentMode='quick';
let companionIndex=0;
let companionTopics=[];
let visitTimer=null;        // interval id
let remainingSeconds=0;     // countdown
let updateProgress;         // assigned after init
let visitData={
  type:'initial',
  provider:'',
  date:'',
  duration:30,
  concerns:[{severity:'severe'},{severity:'moderate'},{severity:'mild'}],
  keyQuestion:'',
  openingLine:'Thank you for seeing me today. I have three main concerns I\'d like to discuss, starting with...',
  story:'',
  evidence:[],
  contingencies:{},
  agendaItems:[]
};

/* ---------- Utils ---------- */
function sanitizeVisitData(v){
  return {
    type:['initial','followup','urgent','medication','insurance','second'].includes(v.type)?v.type:'initial',
    provider:(v.provider||'').slice(0,100),
    date:v.date||new Date().toISOString(),
    duration:[15,30,45,60].includes(+v.duration)?+v.duration:30,
    concerns:(v.concerns||[]).slice(0,3).map(c=>({
      text:(c.text||'').slice(0,140),
      severity:['mild','moderate','severe','crisis','admin'].includes(c.severity)?c.severity:'moderate'
    })),
    keyQuestion:(v.keyQuestion||'').slice(0,200),
    openingLine:(v.openingLine||'').slice(0,200),
    story:(v.story||'').slice(0,800),
    evidence:(v.evidence||[]).slice(0,10),
    contingencies:v.contingencies||{},
    agendaItems:(v.agendaItems||[]).slice(0,20)
  };
}
function showToast(msg,type='info'){
  const el=document.getElementById('toast'); if(!el) return;
  el.textContent=msg; el.className=`toast ${type}`; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),3000);
}
function debounce(fn,wait){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait);}}

/* ---------- DOM Ready ---------- */
window.addEventListener('DOMContentLoaded',()=>{
  if(localStorage.getItem('prepcommand_clinic_safe')==='true'){document.body.classList.add('clinic-safe');}

  initializePrepCommand();
  loadFromTrendTrack();
  loadFromSymptomPro();
  detectVisitType();
  initializeProgressTracking();

  // keyboard + a11y
  document.addEventListener('keydown',(e)=>{
    if(e.key==='Escape'){
      const cmp=document.getElementById('mobileCompanion');
      if(cmp?.classList.contains('active')){
        cmp.classList.remove('active');
        document.querySelector('[aria-label*="Open companion"]')?.focus();
      }
    }
    if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();saveToVault();}
    if((e.ctrlKey||e.metaKey)&&e.key==='p'){e.preventDefault();exportPDF();}
    if(e.key==='Tab'){
      const cmp=document.getElementById('mobileCompanion');
      if(cmp?.classList.contains('active')){
        const f=cmp.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
        const first=f[0], last=f[f.length-1];
        if(e.shiftKey){
          if(document.activeElement===first){e.preventDefault();last.focus();}
        }else{
          if(document.activeElement===last){e.preventDefault();first.focus();}
        }
      }
    }
  });

  // severity keyboard navigation
  document.querySelectorAll('.severity-selector').forEach(group=>{
    group.addEventListener('keydown',(e)=>{
      const btns=Array.from(group.querySelectorAll('.severity-btn'));
      const idx=btns.indexOf(document.activeElement);
      if(idx===-1) return;
      if(e.key==='ArrowRight'||e.key==='ArrowDown'){e.preventDefault();btns[(idx+1)%btns.length].focus();}
      else if(e.key==='ArrowLeft'||e.key==='ArrowUp'){e.preventDefault();btns[idx===0?btns.length-1:idx-1].focus();}
    });
  });

  // duration change (when timer not running)
  const dur=document.getElementById('duration');
  if(dur){
    dur.addEventListener('change',()=>{
      if(!visitTimer){
        const minutes=parseInt(dur.value,10)||30;
        remainingSeconds=minutes*60;
        localStorage.setItem('prepcommand_timer_remaining',String(remainingSeconds));
        renderTimer(remainingSeconds);
      }
    });
  }

  // privacy/mode note
  const note=document.createElement('div');
  note.style.cssText='text-align:center;color:#666;font-size:12px;margin-top:10px;';
  note.innerHTML=firebaseAvailable
    ? 'üîí Private by default - your data stays local unless you explicitly share<br>‚úÖ Connected to cloud backup'
    : 'üîí Private by default - your data stays local unless you explicitly share<br>üíæ Running in local mode (data saves to this device only)';
  document.querySelector('.header')?.appendChild(note);
});

/* ---------- Init helpers ---------- */
async function initializePrepCommand(){
  const now=new Date();
  const dt=document.getElementById('appointmentDate');
  if(dt) dt.value=now.toISOString().slice(0,16);
  await loadSavedData();
  initializeAISuggestions();
}
function initializeProgressTracking(){
  const ids=['visitType','provider','appointmentDate','duration','concern1','concern2','concern3','keyQuestion','openingLine'];
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(el){el.addEventListener('input',()=>updateProgress&&updateProgress());el.addEventListener('change',()=>updateProgress&&updateProgress());}
  });
  if(typeof updateProgress==='function') updateProgress();
}
updateProgress=function(){
  const sections={
    context:{fields:['visitType','provider','appointmentDate'],weight:25,element:'section-context'},
    concerns:{fields:['concern1','concern2','concern3'],weight:35,element:'section-concerns'},
    question:{fields:['keyQuestion'],weight:20,element:'section-question'},
    opening:{fields:['openingLine'],weight:20,element:'section-opening'}
  };
  let total=0;
  Object.values(sections).forEach(s=>{
    const filled=s.fields.filter(id=>{const el=document.getElementById(id);return el&&el.value&&el.value.trim().length>0;}).length;
    total+=(filled/s.fields.length)*s.weight;
    const el=document.getElementById(s.element);
    if(el){if(filled===s.fields.length) el.classList.add('completed'); else el.classList.remove('completed');}
  });
  const bar=document.querySelector('.progress-fill');
  const txt=document.getElementById('progressText');
  if(bar) bar.style.width=`${total}%`;
  if(txt){
    if(total===0) txt.textContent='Getting started - 0% complete';
    else if(total<25) txt.textContent=`Getting started - ${Math.round(total)}% complete`;
    else if(total<50) txt.textContent=`Making progress - ${Math.round(total)}% complete`;
    else if(total<75) txt.textContent=`Almost there - ${Math.round(total)}% complete`;
    else if(total<100) txt.textContent=`Nearly done - ${Math.round(total)}% complete`;
    else{
      txt.textContent='Ready for your visit! 100% complete üéâ';
      const cont=document.querySelector('.progress-container');
      cont?.classList.add('success-animation'); setTimeout(()=>cont?.classList.remove('success-animation'),500);
    }
  }
  return total;
};

/* ---------- External Data ---------- */
async function loadFromTrendTrack(){
  try{
    const raw=localStorage.getItem('trendtrack_latest'); if(!raw) return;
    const data=JSON.parse(raw);
    if(data.topSymptoms?.[0]){
      const c1=document.getElementById('concern1'); if(c1) c1.value=data.topSymptoms[0];
      showAISuggestion(1,`Based on TrendTrack: This symptom peaked ${data.peakTime}`);
    }
  }catch{}
}
async function loadFromSymptomPro(){
  try{
    const raw=localStorage.getItem('symptompro_latest'); if(!raw) return;
    const data=JSON.parse(raw);
    visitData.story=generateOLDCARTS(data);
  }catch{}
}
function detectVisitType(){
  const params=new URLSearchParams(window.location.search);
  const type=params.get('type');
  if(type){const sel=document.getElementById('visitType'); if(sel) sel.value=type; updateVisitType();}
}

/* ---------- Story helpers ---------- */
function generateOLDCARTS(d){
  const parts=[];
  if(d.onset) parts.push(`Started ${d.onset}`);
  if(d.location) parts.push(`Located in ${d.location}`);
  if(d.duration) parts.push(`Lasting ${d.duration}`);
  if(d.character) parts.push(`Feels like ${d.character}`);
  if(d.aggravating) parts.push(`Worsened by ${d.aggravating}`);
  if(d.relieving) parts.push(`Improved by ${d.relieving}`);
  if(d.timing) parts.push(`Occurs ${d.timing}`);
  if(d.severity) parts.push(`Severity ${d.severity}/10`);
  return parts.join('. ')+ (parts.length?'.':'');
}
function generateQuickStory(){
  const concern=visitData.concerns[0].text||'my symptoms';
  const severity=visitData.concerns[0].severity;
  return `I've been experiencing ${concern} for [duration]. The severity is ${severity}, affecting my ability to [daily activity]. It feels like [description]. It gets worse with [trigger] and improves with [relief]. This pattern occurs [timing]. Current severity is [X/10].`;
}

/* ---------- Mode & inputs ---------- */
window.switchMode=function(mode,e){
  currentMode=mode;
  document.querySelectorAll('.mode-button').forEach(b=>b.classList.remove('active'));
  e?.currentTarget?.classList.add('active');

  document.getElementById('quickMode')?.classList.remove('active');
  document.getElementById('comprehensiveMode')?.classList.remove('active');
  document.getElementById('mobileCompanion')?.classList.remove('active');

  if(mode==='quick') document.getElementById('quickMode')?.classList.add('active');
  else if(mode==='comprehensive') document.getElementById('comprehensiveMode')?.classList.add('active');
  else if(mode==='companion'){document.getElementById('mobileCompanion')?.classList.add('active'); startCompanionMode();}
  showToast(t('switchedMode',{mode}),'info');
};

window.updateVisitType=function(){
  const sel=document.getElementById('visitType'); if(!sel) return;
  visitData.type=sel.value;
  switch(visitData.type){
    case 'initial': showAISuggestion(1,'For initial visits, focus on establishing the timeline and severity'); generateSuggestedQuestion('What tests or evaluations do you recommend to understand this better?'); break;
    case 'followup': showAISuggestion(1,'Reference changes since last visit'); generateSuggestedQuestion('Based on my response to treatment, what adjustments should we make?'); break;
    case 'urgent': showAISuggestion(1,'Emphasize acute changes and safety concerns'); generateSuggestedQuestion('What red flags should I watch for that would require immediate care?'); break;
    case 'insurance': showAISuggestion(3,'Have authorization numbers and denial letters ready'); generateSuggestedQuestion('What documentation would strengthen my appeal?'); break;
  }
};

window.setSeverity=function(n,severity,e){
  visitData.concerns[n-1].severity=severity;
  const card=document.querySelectorAll('.concern-card')[n-1]; if(!card) return;
  const buttons=card.querySelectorAll('.severity-btn');
  buttons.forEach(b=>{b.classList.remove('selected'); b.setAttribute('aria-pressed','false');});
  e?.currentTarget?.classList.add('selected'); e?.currentTarget?.setAttribute('aria-pressed','true');
  if(typeof updateProgress==='function') updateProgress();
};
function showAISuggestion(n,text){
  const el=document.getElementById(`suggestion${n}`); if(!el) return;
  el.textContent=`üí° AI: ${text}`; el.classList.add('visible');
}

/* ---------- AI helpers ---------- */
window.generateQuestion=function(){
  const concern=document.getElementById('concern1')?.value || 'this';
  const type=visitData.type || 'initial';
  showToast(t('generatingQuestion'),'info');
  setTimeout(()=>{
    const q={
      initial:`What specific tests would help us understand why I'm experiencing ${concern}?`,
      followup:`Given that ${concern} hasn't improved with current treatment, what are our next options?`,
      urgent:`What immediate evaluations do we need for ${concern}, and what would indicate emergency care?`,
      medication:`Could my ${concern} be related to medication side effects, and should we adjust dosing?`,
      insurance:`What clinical documentation would support medical necessity for treating ${concern}?`,
      second:`How does your approach to ${concern} differ from my previous provider's treatment plan?`
    };
    document.getElementById('keyQuestion').value=q[type]||q.initial;
    showToast(t('questionGenerated'),'success');
  },1500);
};
window.generateOpening=function(){
  const concerns=['concern1','concern2','concern3'].map(id=>document.getElementById(id)?.value).filter(Boolean);
  showToast(t('generatingOpening'),'info');
  setTimeout(()=>{
    const opts=[
      `Thank you for seeing me today. I have ${concerns.length||'a few'} main concerns, with ${concerns[0]||'my symptoms'} being most urgent.`,
      `I appreciate your time. I've prepared my top concerns to make the most of our visit, starting with ${concerns[0]||'my primary issue'}.`,
      `I've documented my symptoms carefully. My biggest concern today is ${concerns[0]||'the issue affecting my daily life most'}.`,
      `Thank you for fitting me in. I need your help with ${concerns.length||'several'} issues, particularly ${concerns[0]||'my main symptom'}.`
    ];
    document.getElementById('openingLine').value=opts[Math.floor(Math.random()*opts.length)];
    showToast(t('openingGenerated'),'success');
  },1500);
};

/* ---------- Prep + Preview ---------- */
window.generatePrep=function(){
  const btn=event?.target;
  if(btn){btn.disabled=true; btn.dataset.old=btn.innerHTML; btn.innerHTML='‚è≥ Generating...';}
  showToast(t('generatingPrep'),'info');

  visitData.concerns=[
    {text:document.getElementById('concern1')?.value||'',severity:visitData.concerns[0].severity},
    {text:document.getElementById('concern2')?.value||'',severity:visitData.concerns[1].severity},
    {text:document.getElementById('concern3')?.value||'',severity:visitData.concerns[2].severity}
  ];
  visitData.keyQuestion=document.getElementById('keyQuestion')?.value||'';
  visitData.openingLine=document.getElementById('openingLine')?.value||'';
  visitData.provider=document.getElementById('provider')?.value||'';
  visitData.date=document.getElementById('appointmentDate')?.value||'';
  visitData= sanitizeVisitData(visitData);

  if(!visitData.story) visitData.story=generateQuickStory();

  setTimeout(()=>{
    updatePreview(); viewPreview();
    if(btn){
      btn.innerHTML='‚úì Prep Complete!'; btn.classList.add('success-animation');
      setTimeout(()=>{btn.innerHTML=btn.dataset.old||'‚ú® Generate Visit Prep'; btn.disabled=false; btn.classList.remove('success-animation');},2000);
    }
    showToast(t('prepComplete'),'success'); saveToVault();
  },2000);
};
function updatePreview(){
  const meta=document.getElementById('previewMeta');
  if(meta){
    const prov=visitData.provider||'[Provider]';
    const date=visitData.date?new Date(visitData.date).toLocaleDateString():'[Date]';
    meta.textContent=`${visitData.type.toUpperCase()} - ${prov} - ${date}`;
  }
  const focus=document.getElementById('previewFocus');
  if(focus){focus.innerHTML=visitData.concerns.filter(c=>c.text).map(c=>`<li>${c.text} (${c.severity})</li>`).join('');}
  const story=document.getElementById('previewStory'); if(story) story.textContent=visitData.story||'';
  const ev=document.getElementById('previewEvidence');
  if(ev){ev.innerHTML=`<li>Symptom diary shows pattern over past 3 months</li><li>Previous treatments tried: [List]</li><li>Impact on work/daily life: [Specific examples]</li>`;}
  const qs=document.getElementById('previewQuestions');
  if(qs){qs.innerHTML=`<li>"${visitData.keyQuestion||'[Primary diagnostic or treatment question]'}"</li><li>"What should I monitor between now and our next visit?"</li><li>"When should we schedule a follow-up to assess progress?"</li>`;}
}
window.viewPreview=function(){
  const p=document.getElementById('previewPanel'); if(p){p.classList.add('active'); p.scrollIntoView({behavior:'smooth'});}
};

/* ---------- PDF ---------- */
window.exportPDF=async function(){
  const el=document.getElementById('previewPanel');
  const btn=event?.target;
  const opt={margin:10,filename:`PrepCommand_${new Date().toISOString().split('T')[0]}.pdf`,image:{type:'jpeg',quality:.98},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
  if(btn){btn.disabled=true; btn.dataset.old=btn.innerHTML; btn.innerHTML='‚è≥ Generating...';}
  try{
    await html2pdf().set(opt).from(el).save();
    if(btn){btn.innerHTML='‚úì Downloaded!'; setTimeout(()=>{btn.innerHTML=btn.dataset.old; btn.disabled=false;},2000);}
    showToast(t('pdfDownloaded'),'success');
  }catch(e){
    if(btn){btn.innerHTML=btn.dataset.old; btn.disabled=false;}
    showToast(t('pdfError'),'error');
  }
};

/* ---------- Share / Text ---------- */
window.textToPhone=function(){
  const summary=`VISIT PREP:\n\n1. ${visitData.concerns[0]?.text||''}\n2. ${visitData.concerns[1]?.text||''}\n3. ${visitData.concerns[2]?.text||''}\n\nKEY QUESTION: ${visitData.keyQuestion||''}\n\nOPENING: ${visitData.openingLine||''}`;
  const modal=document.createElement('div');
  modal.innerHTML=`
    <div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:30px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.2);z-index:3000;">
      <h3>Send Summary to Phone</h3>
      <p style="color:#666;margin:10px 0;">Your data will be encrypted. Standard messaging rates may apply.</p>
      <textarea style="width:100%;height:120px;border:1px solid #ddd;border-radius:4px;padding:8px;margin-bottom:10px;">${summary}</textarea>
      <input type="tel" placeholder="Phone number" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ddd;border-radius:4px;">
      <div style="display:flex;gap:10px;">
        <button onclick="this.closest('div').parentElement.remove()" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">Cancel</button>
        <button onclick="sendTextConfirmed(this)" style="flex:1;padding:10px;border:none;background:var(--primary-green);color:#fff;border-radius:4px;cursor:pointer;">Send Securely</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
};
window.sendTextConfirmed=function(btn){btn.closest('div').parentElement.remove();showToast(t('textFeatureComing'),'info');};
window.shareWithAdvocate=async function(){
  if(navigator.share){
    try{await navigator.share({title:'My Visit Prep',text:'I\'ve prepared for my medical appointment. Can you review this with me?',url:window.location.href});showToast(t('sharedSuccess'),'success');}
    catch{}
  }else{navigator.clipboard.writeText(window.location.href);showToast(t('linkCopied'),'success');}
};

/* ---------- Companion (fixed timer) ---------- */
window.openCompanion=function(){document.getElementById('mobileCompanion')?.classList.add('active'); startCompanionMode();};

function startCompanionMode(){
  companionTopics=visitData.concerns.map(c=>c.text).filter(Boolean);
  companionIndex=0;

  const minutes=parseInt(document.getElementById('duration')?.value || visitData.duration || 30,10);
  remainingSeconds=(isNaN(minutes)?30:minutes)*60;

  updateCompanionView();
  startVisitTimer();
}
function updateCompanionView(){
  const current=companionTopics[companionIndex] || 'Opening statement';
  const next=companionTopics[companionIndex+1] || 'Wrap-up and next steps';
  const curEl=document.getElementById('currentTopic');
  const nextEl=document.getElementById('nextTopic');
  if(curEl) curEl.textContent=current;
  if(nextEl) nextEl.textContent=next;
}
function renderTimer(secs){
  const el=document.getElementById('visitTimer'); if(!el) return;
  const m=Math.floor(secs/60), s=secs%60;
  el.textContent=`${m}:${s.toString().padStart(2,'0')}`;
  el.style.background=secs<=300?'var(--primary-coral)':'var(--dusty-teal)';
}
function startVisitTimer(){
  if(visitTimer) clearInterval(visitTimer);
  renderTimer(remainingSeconds);
  visitTimer=setInterval(()=>{
    remainingSeconds--;
    renderTimer(remainingSeconds);
    if(remainingSeconds<=0){
      clearInterval(visitTimer); visitTimer=null;
      const el=document.getElementById('visitTimer'); if(el) el.textContent="Time's up";
    }
  },1000);
}

window.goBack=function(){
  if(companionIndex>0){companionIndex--; updateCompanionView(); showToast('Moved back to previous topic','info');}
};
window.needPhrase=function(){const helps=strings.en.needPhraseHelps; const pick=helps[Math.floor(Math.random()*helps.length)]; showToast(pick,'info');};
window.dataForward=function(){showToast(t('dataForwardPrompt'),'info');};
window.recordNote=function(){showToast(t('voiceStarted'),'info');};
window.groundingBreak=function(){showToast(t('groundingPrompt'),'info');};
window.flagForFollowup=function(){
  const item=document.getElementById('currentTopic')?.textContent || '';
  if(!visitData.flaggedItems) visitData.flaggedItems=[];
  visitData.flaggedItems.push(item);
  showToast(t('flaggedFollowup',{item}),'success');
};
window.closeCompanion=function(){
  document.getElementById('mobileCompanion')?.classList.remove('active');
  localStorage.setItem('prepcommand_companion_index',String(companionIndex));
  if(visitTimer){clearInterval(visitTimer); visitTimer=null;}
};

/* ---------- Save/Load ---------- */
async function saveToVault(silent=false){
  try{
    const payload={tool:'PrepCommand',timestamp:new Date().toISOString(),visitData:sanitizeVisitData(visitData),summary:generateSummaryForVault(),version:'prepcommand_v1'};
    localStorage.setItem('prepcommand_latest_v1',JSON.stringify(payload));
    if(firebaseAvailable && db){
      try{
        const {setDoc,doc}=await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        await setDoc(doc(db,'vault',`prepcommand_${Date.now()}`),payload);
        if(!silent) showToast('Data saved with cloud backup ‚òÅÔ∏è','success');
      }catch{ if(!silent) showToast('Data saved locally üíæ','success'); }
    }else if(!silent){ showToast('Data saved successfully!','success'); }
    return true;
  }catch(e){ if(!silent) showToast(t('errorSaving'),'error'); return false; }
}
async function loadSavedData(){
  try{
    const raw=localStorage.getItem('prepcommand_latest_v1');
    if(raw){const data=JSON.parse(raw); if(data.visitData){visitData=sanitizeVisitData(data.visitData); restoreFormData();}}
    const idx=localStorage.getItem('prepcommand_companion_index'); if(idx) companionIndex=parseInt(idx,10)||0;
  }catch{}
}
function restoreFormData(){
  const set=(id,val)=>{const el=document.getElementById(id); if(el && val!==undefined) el.value=val;};
  set('provider',visitData.provider); set('appointmentDate',visitData.date); set('duration',visitData.duration); set('visitType',visitData.type);
  set('concern1',visitData.concerns[0]?.text); set('concern2',visitData.concerns[1]?.text); set('concern3',visitData.concerns[2]?.text);
  set('keyQuestion',visitData.keyQuestion); set('openingLine',visitData.openingLine);
  if(typeof updateProgress==='function') updateProgress();
}
function generateSummaryForVault(){
  const date=visitData.date?new Date(visitData.date).toLocaleDateString():'[Date]';
  const concerns=visitData.concerns.map(c=>c.text).filter(Boolean).join(', ');
  return `Visit prep for ${visitData.provider||'[Provider]'} on ${date}. Top concerns: ${concerns}. Key question: ${visitData.keyQuestion||''}`;
}

/* ---------- AI suggestions init ---------- */
function initializeAISuggestions(){
  const c1=document.getElementById('concern1');
  if(c1) c1.addEventListener('input',debounce(()=>{if(c1.value.length>10) showAISuggestion(1,'Consider adding impact on daily activities');},1000));
  const c2=document.getElementById('concern2');
  if(c2) c2.addEventListener('input',debounce(()=>{if(c2.value.length>10) showAISuggestion(2,'Link this to your primary concern if related');},1000));
}
function generateSuggestedQuestion(q){
  const el=document.getElementById('keyQuestion'); if(el && !el.value) el.placeholder=q;
}

/* ---------- Comprehensive helpers ---------- */
window.addTimelineItem=function(){
  const div=document.getElementById('timelineItems'); if(!div) return;
  const el=document.createElement('div'); el.className='timeline-item';
  el.innerHTML=`<input type="text" placeholder="Time range" style="width:100px;padding:8px;border:1px solid var(--border-color);border-radius:4px;">
  <input type="text" placeholder="Topic to discuss" style="flex:1;padding:8px;border:1px solid var(--border-color);border-radius:4px;">
  <select style="padding:8px;border:1px solid var(--border-color);border-radius:4px;">
    <option value="must">Must Do</option><option value="should">Should Do</option><option value="could">Could Do</option></select>`;
  div.appendChild(el);
};
window.generateFullAgenda=function(){showToast(t('generatingAgenda'),'info'); setTimeout(()=>{showToast(t('agendaGenerated'),'success'); viewPreview();},2000);};
window.printAgendaCard=function(){window.print();};

/* ---------- Clinic-safe mode ---------- */
window.toggleClinicSafe=function(){
  document.body.classList.toggle('clinic-safe');
  const on=document.body.classList.contains('clinic-safe');
  showToast(on?'Clinic-safe mode enabled':'Clinic-safe mode disabled','info');
  localStorage.setItem('prepcommand_clinic_safe',String(on));
};

/* ---------- Auto-save ---------- */
let lastAutoSave=Date.now();
setInterval(()=>{
  const any=document.getElementById('concern1')?.value || document.getElementById('concern2')?.value || document.getElementById('concern3')?.value;
  if(!any) return;
  if(Date.now()-lastAutoSave>30000){
    saveToVault(true); lastAutoSave=Date.now();
    const ind=document.createElement('div');
    ind.style.cssText='position:fixed;top:10px;right:10px;background:var(--mossy-green);color:#fff;padding:5px 10px;border-radius:4px;font-size:12px;opacity:.9;z-index:1000;';
    ind.textContent='‚úì Auto-saved'; document.body.appendChild(ind);
    setTimeout(()=>{ind.style.transition='opacity .3s'; ind.style.opacity='0'; setTimeout(()=>ind.remove(),300);},2000);
  }
},60000);

/* ---------- PWA ---------- */
if('serviceWorker' in navigator && window.location.hostname!=='claudeusercontent.com'){
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}
</script>

</body>
</html>